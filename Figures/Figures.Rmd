---
title: "Manuscript Figures"
author: "Weihsueh Chiu"
date: "`r format(Sys.time(), '%F')`"
output:
  word_document: default
  pdf_document: default
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
library(coda)
library(bayesplot) 
library(ggplot2)
library(stringr)
library(knitr)
library(ggpubr)
library(dplyr)
library(metR)
library(data.table)
library(usmap)
# library(reshape2)
# library(here)
# library(covid19us)
# library(jsonlite)
# library(rvest)
# library(gridExtra)
# library(GGally)
# library(RCurl)
knitr::opts_chunk$set(echo = TRUE, dpi = 300, fig.height=6, fig.width=6,message = FALSE,warning=FALSE)
functiondir <- "../functions"
modeldir <- "../model"
datezero <- "2019-12-31"
source(file.path(functiondir,"get_reopendata_function.R"))
```

```{r load full results, echo=FALSE, include=FALSE}
folder <- "../SEIR.reopen.state.alt2.2020.06.20"

fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code
fips_table$Region <- "South"
fips_table$Region[fips_table$Alpha.code %in% c("CT","ME","MA","NH","RI",
                                               "VT","NJ","NY","PA")] <- "Northeast"
fips_table$Region[fips_table$Alpha.code %in% c("IL","IN","MI","OH","WI","IA",
                                               "KS","MN","MO","NE","ND","SD")] <- "Midwest"
fips_table$Region[fips_table$Alpha.code %in% c("AZ","CO","ID","MT","NV","NM","UT","WY",
                                               "AK","CA","HI","OR","WA")] <- "West"

statesarr <- fips_table$Alpha.code[2:52]
## Read prediction files

allpreddat <- data.frame()
for (statenow in statesarr) { 
  csvfile <- list.files(path=file.path(folder,statenow),
                           pattern="*prediction.quantiles.csv",
                         full.names=TRUE)
  preddat <- read.csv(csvfile,as.is=TRUE)
  preddat$state <- statenow
  allpreddat <- rbind(allpreddat,preddat)
}
allpreddat$Output_Var[allpreddat$Output_Var=="N_pos"] <- "positiveIncrease"
allpreddat$Output_Var[allpreddat$Output_Var=="D_pos"] <- "deathIncrease"
allpreddat$Output_Var[allpreddat$Output_Var=="CumPosTest"] <- "positive"
allpreddat$Output_Var[allpreddat$Output_Var=="CumDeath"] <- "death"
allpreddat$Date <- as.Date(allpreddat$Time,origin=as.Date(datezero))

## Read data files
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"))
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"))
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

# get reopening data
reopen.df <- get_reopendata(datadir = "../data")
minreopen<-aggregate(value~State.Abbr,data=reopen.df,min,na.rm=TRUE)
rownames(minreopen)<-minreopen$State.Abbr
```

```{r Refft at reopening, echo=FALSE,fig.height=3,fig.width=6}

preddat.reopen.df <- subset(allpreddat,Output_Var=="Refft")
preddat.reopen.df <- preddat.reopen.df[preddat.reopen.df$Date==minreopen[preddat.reopen.df$state,"value"],]
preddat.reopen.df$Category <- "R[eff](t) ~ 1" # bquote(R[eff](t)%~~%1) 
preddat.reopen.df$Category[preddat.reopen.df$Prediction.75.<1] <- "R[eff](t) < 1"
preddat.reopen.df$Category[preddat.reopen.df$Prediction.25.>1] <- "R[eff](t) > 1"
preddat.reopen.df$Category<-factor(preddat.reopen.df$Category,
                            levels=
                              c("R[eff](t) < 1","R[eff](t) ~ 1","R[eff](t) > 1"))
rownames(preddat.reopen.df)<- preddat.reopen.df$state
pReffShelter <- ggplot(preddat.reopen.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),
               stat="identity")+
    scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)))+
  xlab("")+
  ylim(0,2.5)+ylab(bquote(R[eff](t)))+
  geom_hline(yintercept=1,size=2,alpha=0.6)+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="none")+
  geom_text(aes(x=state,y=0.02+Prediction.97.5.,label=Date,angle=90),hjust=0,size=2)+
  ggtitle(bquote(paste(R[eff](t)," estimated at end of shelter-in-place/beginning of reopening")))
print(pReffShelter)
ggsave("Refft.Shelter.pdf",plot=pReffShelter,height=3,width=6,scale=1.75)
ggsave("Refft.Shelter.jpeg",plot=pReffShelter,height=3,width=6,scale=1.75)
```

```{r Refft at minimum Rt, echo=FALSE,fig.height=3,fig.width=6}

preddat.minRt.df<-subset(allpreddat,Output_Var=="Refft" & 
                           Date <= as.Date("2020-06-20")) %>% 
  group_by(state) %>% 
  slice(which.min(Prediction.50.))
preddat.minRt.df$Category <- "R[eff](t) ~ 1"
preddat.minRt.df$Category[preddat.minRt.df$Prediction.75.<1] <- "R[eff](t) < 1"
preddat.minRt.df$Category[preddat.minRt.df$Prediction.25.>1] <- "R[eff](t) > 1"
preddat.minRt.df$Category<-factor(preddat.minRt.df$Category,
                            levels=
                              c("R[eff](t) < 1","R[eff](t) ~ 1","R[eff](t) > 1"))
rownames(preddat.minRt.df)<- preddat.minRt.df$state
pReffMin <- ggplot(preddat.minRt.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),
               stat="identity")+
    scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)),drop=FALSE)+
  xlab("")+
  ylim(0,2.5)+ylab(bquote(R[eff](t)))+
  geom_hline(yintercept=1,size=2,alpha=0.6)+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="none")+
  geom_text(aes(x=state,y=0.02+Prediction.97.5.,label=Date,angle=90),hjust=0,size=2)+
  ggtitle(bquote(paste("Minimum value of ",R[eff](t),)))
print(pReffMin)
ggsave("Refft.Min.pdf",plot=pReffMin,height=3,width=6,scale=1.75)
ggsave("Refft.Min.jpeg",plot=pReffMin,height=3,width=6,scale=1.75)
```

```{r Refft at 2020-06-20, echo=FALSE,fig.height=3,fig.width=6}
preddat.df <- subset(allpreddat,Output_Var=="Refft")
preddat.df <- preddat.df[preddat.df$Date==as.Date("2020-06-20"),]
preddat.df$Category <- "R[eff](t) ~ 1"
preddat.df$Category[preddat.df$Prediction.75.<1] <- "R[eff](t) < 1"
preddat.df$Category[preddat.df$Prediction.25.>1] <- "R[eff](t) > 1"
preddat.df$Category<-factor(preddat.df$Category,
                            levels=
                              c("R[eff](t) < 1","R[eff](t) ~ 1","R[eff](t) > 1"))
rownames(preddat.df)<- preddat.df$state
pReffnow <- ggplot(preddat.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),
               stat="identity")+
    scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)))+
  xlab("")+
  ylim(0,2.5)+ylab(bquote(R[eff](t)))+
  geom_hline(yintercept=1,size=2,alpha=0.6)+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="none")+
  ggtitle(bquote(paste(R[eff](t)," estimated 2020-06-20")))
print(pReffnow)
ggsave("Refft.2020.06.20.pdf",plot=pReffnow,height=3,width=6,scale=1.75)
ggsave("Refft.2020.06.20.jpeg",plot=pReffnow,height=3,width=6,scale=1.75)

fips_table$RtCategory <- preddat.df[fips_table$Alpha.code,"Category"]
```


```{r combined with reopening, echo=FALSE,fig.height=3,fig.width=6}
pReffcombreopen <- ggplot(preddat.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),alpha=0.5,color="grey",
               stat="identity",data=preddat.reopen.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),
               stat="identity")+
    scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)),drop=FALSE)+
  xlab("")+
  ylim(0,2.5)+ylab(bquote(R[eff](t)))+
  geom_hline(yintercept=1,size=2,alpha=0.6)+
  geom_text(aes(x=state,y=0,label=Date,angle=90),
            data=preddat.reopen.df,
            hjust=0.25,size=2)+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="none")+
  ggtitle(bquote(paste(R[eff](t)," estimated at reopening and 2020-06-20")))
print(pReffcombreopen)
ggsave("Refft.comb.reopen.pdf",plot=pReffcombreopen,height=3,width=6,scale=1.75)
ggsave("Refft.comb.reopen.jpeg",plot=pReffcombreopen,height=3,width=6,scale=1.75)

```

```{r combined with min, echo=FALSE,fig.height=3,fig.width=6}
pReffcombmin <- ggplot()+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),alpha=0.5,color="grey60",
               stat="identity",data=preddat.minRt.df)+
  geom_boxplot(aes(x=state,middle=Prediction.50.,
                   lower=Prediction.25.,upper=Prediction.75.,
                   ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                   fill=Category),
               stat="identity",data=preddat.df)+
  scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)),drop=FALSE)+
    xlab("")+
  ylim(0,2.5)+ylab(bquote(R[eff](t)))+
  geom_hline(yintercept=1,size=2,alpha=0.6)+
  geom_text(aes(x=state,y=0,label=Date,angle=90),
            data=preddat.minRt.df,color="grey40",
            hjust=0.25,size=2)+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="none")+
  ggtitle(bquote(paste(R[eff](t)," at minimum and 2020-06-20")))
print(pReffcombmin)
ggsave("Refft.comb.min.pdf",plot=pReffcombmin,height=3,width=6,scale=1.75)
ggsave("Refft.comb.min.jpeg",plot=pReffcombmin,height=3,width=6,scale=1.75)

```


```{r load parameters, echo=FALSE}
## Load parameters
folder <- "../SEIR.reopen.state.alt2.2020.06.20"
numDate <- as.numeric(as.Date("2020-06-20"))-as.numeric(as.Date(datezero))
t <- numDate
allparms <- data.frame()
allpriors <- data.frame()
for (statenow in statesarr) { 
  sampfile <- list.files(path=file.path(folder,statenow),
                           pattern="*samps.out",
                         full.names=TRUE)
  parms <- read.delim(sampfile,as.is=TRUE,sep=" ")
  names(parms)<-gsub(".1.","",names(parms))
  names(parms)<-gsub("GM_","",names(parms))
  parms$state <- factor(statenow,levels=(sort(statesarr)))
  parms$Log10NInit <- log10(parms$NInit)
  parms$alpha <- 1/parms$TIsolation
  parms$kappa <- 1/parms$TLatent
  parms$rho <- 1/parms$TRecover
  parms$lambda0 <- parms$TestingCoverage*parms$TestSensitivity/parms$TTestingRate;
  parms$lambda0_C <- 1.0*parms$TestSensitivity/parms$TContactsTestingRate;
  parms$rho0_C <- 1.0*(1.0 - parms$TestSensitivity)/parms$TContactsTestingRate;
  parms$beta0 <- parms$R0 * parms$rho / parms$c0;
  parms$HygieneMin <- parms$ThetaMin^parms$HygienePwr;
  ## Time dependent parameters, evaluated at last day
  parms$ThetaFit <- (parms$ThetaMin - 
                        (parms$ThetaMin - 1)*
                        exp(-((t-60)/parms$TauTheta)^parms$PwrTheta));
  ## Reopening - increase contacts/day
  parms$TimeReopen = 60+parms$TauTheta+parms$TauS;
  parms$ReopenStart = (1 - 1/(1 + exp(4*(t - parms$TimeReopen))));
  parms$ReopenStop =  (1 - 1/(1 + exp(4*(t - (parms$TimeReopen+parms$TauR)))));
  parms$ReopenPct = ((t - parms$TimeReopen)*(parms$rMax/parms$TauR)*(parms$ReopenStart-parms$ReopenStop)+parms$rMax*parms$ReopenStop);
  ## Contacts/day
  parms$c = parms$c0 * (parms$ThetaFit + (1 - parms$ThetaMin) * parms$ReopenPct); 
  ## Hygiene - reduce infection probability/infected contact
  parms$HygieneFit <- parms$ThetaFit^parms$HygienePwr;
  parms$beta <- parms$beta0 * parms$HygieneFit; # infection probability/infected contact
  parms$Delta <- (parms$c*parms$beta -
                              parms$c0*parms$beta0*
                              parms$ThetaMin^(1+parms$HygienePwr))/
    (parms$c0*parms$beta0 -
       parms$c0*parms$beta0*
       parms$ThetaMin^(1+parms$HygienePwr))
  ## Time dependence of testing/contact tracting
  parms$TestingTimeDep <- (1-1/(1+exp((t-parms$TStartTesting)/parms$TauTesting))); 
  ## Contact tracing
  parms$FTraced <- parms$FracTraced * parms$TestingTimeDep;
  ## Testing
  parms$lambda <- parms$TestingTimeDep * parms$lambda0; 
  parms$lambda_C <- parms$TestingTimeDep * parms$lambda0_C; 
  parms$rho_C <- parms$TestingTimeDep * parms$rho0_C;
  parms$fracpos = parms$FTraced*parms$lambda_C/(parms$lambda_C + parms$rho_C)+(1-parms$FTraced)*parms$lambda/(parms$lambda+parms$rho); # fraction of infected that are tested and positive
  ## Case fatality
  parms$fracposmin <- parms$IFR / 0.9; # max 90% of cases fatal
  parms$CFR <- ifelse(parms$fracpos > parms$fracposmin, parms$IFR/parms$fracpos, 0.9); # Adjust infected fatality to (tested) case fatality
  parms$delta <- parms$rho * parms$CFR/(1-parms$CFR);
  allparms <- rbind(allparms,parms)
  
  
  ## Load priors
  priorfile <- list.files(path=file.path(folder,statenow),
                           pattern="*MTC.out",
                         full.names=TRUE)
  priors <- read.delim(priorfile,as.is=TRUE)
  priors <- priors[,names(priors)!="NInit_1.1"]
  names(priors)<-gsub("GM_","",names(priors))
  priors$state <- factor(statenow,levels=(sort(statesarr)))
  priors$Log10NInit <- log10(priors$NInit)
  priors$alpha <- 1/priors$TIsolation
  priors$kappa <- 1/priors$TLatent
  priors$rho <- 1/priors$TRecover
  priors$lambda0 <- priors$TestingCoverage*priors$TestSensitivity/priors$TTestingRate;
  priors$lambda0_C <- 1.0*priors$TestSensitivity/priors$TContactsTestingRate;
  priors$rho0_C <- 1.0*(1.0 - priors$TestSensitivity)/priors$TContactsTestingRate;
  priors$beta0 <- priors$R0 * priors$rho / priors$c0;
  ## Time dependent parameters, evaluated at last day
  priors$ThetaFit <- (priors$ThetaMin - 
                        (priors$ThetaMin - 1)*
                        exp(-((t-60)/priors$TauTheta)^priors$PwrTheta));

  priors$HygieneMin <- priors$ThetaMin^priors$HygienePwr;
  ## Time dependent parameters, evaluated at last day
  priors$ThetaFit <- (priors$ThetaMin - 
                        (priors$ThetaMin - 1)*
                        exp(-((t-60)/priors$TauTheta)^priors$PwrTheta));
  ## Reopening - increase contacts/day
  priors$TimeReopen = 60+priors$TauTheta+priors$TauS;
  priors$ReopenStart = (1 - 1/(1 + exp(4*(t - priors$TimeReopen))));
  priors$ReopenStop =  (1 - 1/(1 + exp(4*(t - (priors$TimeReopen+priors$TauR)))));
  priors$ReopenPct = ((t - priors$TimeReopen)*(priors$rMax/priors$TauR)*(priors$ReopenStart-priors$ReopenStop)+priors$rMax*priors$ReopenStop);
  names(priors)[names(priors)=="Iter"]<-"iter"
  allpriors <- rbind(allpriors,priors)
  
}
allparms.med<-aggregate(.~state,data=allparms,median)
allparms$Region <- fips_table[allparms$state,"Region"]
allparms.med$Region <- fips_table[allparms.med$state,"Region"]
allparms$Category <- fips_table[as.character(allparms$state),"RtCategory"]
allparms.med$Category <- fips_table[as.character(allparms.med$state),"RtCategory"]



```

```{r transmission rebound at 2020-06-20, echo=FALSE,fig.height=2,fig.width=6}
prebound <- ggplot(allparms)+
  geom_col(aes(x=state,y=100*Delta,fill=Category),data=allparms.med)+
  geom_boxplot(aes(x=state,y=100*Delta),alpha=0,outlier.shape = NA)+
    scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)),drop=FALSE)+
xlab("")+
  ylim(0,100)+
  ylab(bquote(Delta(t)))+
  labs(fill="Category based on IQR")+
  theme_bw()+theme(legend.position="bottom")+
#  geom_text(aes(x=state,y=0.02+Prediction.97.5.,label=Date,angle=90),hjust=0,size=2)+
  ggtitle(bquote(paste("Transmission Rebound ",Delta," estimated 2020-06-20")))
print(prebound)
ggsave("Rebound.2020.06.20.pdf",plot=prebound,height=2,width=6,scale=1.75)
ggsave("Rebound.2020.06.20.jpeg",plot=prebound,height=2,width=6,scale=1.75)

figReffRebound<-ggarrange(pReffcombmin,prebound,
                  nrow=2,heights=c(2,1),labels = c("A", "B"))
print(figReffRebound)
ggsave("Fig2_ReffRebound.pdf",plot=figReffRebound,height=4,width=6,scale=1.75)
ggsave("Fig2_ReffRebound.jpeg",plot=figReffRebound,height=4,width=6,scale=1.75)
```

```{r supplemental file with all priors and posteriors}
parmstoplot<-c("Log10NInit",
               "alpha",
               "R0",
               "c0",
               "kappa",
               "rho",
               "IFR",
               "TStartTesting",
               "TauTesting",
               "TTestingRate",
               "TContactsTestingRate",
               "TestingCoverage",
               "TestSensitivity",
               "ThetaMin",
               "TauTheta",
               "PwrTheta",
               "HygienePwr",
               "TauS",
               "ReopenPct",
               "TauR",
               "FracTraced",
               "TPosTest",
               "TFatalDeath",
               "alpha_Pos",
               "alpha_Death")
idvars<-c("iter","state","Region","Category")
allparms.df <- allparms[,(names(allparms) %in% c(idvars,parmstoplot))]
allparms.df <- melt(as.data.table(allparms.df),id.vars=idvars)
allparms.df$variable<-factor(allparms.df$variable,
                             levels=parmstoplot)
allpriors.df <- allpriors[,(names(allpriors) %in% c(idvars,parmstoplot))]
allpriors.df <- melt(as.data.table(allpriors.df),id.vars=c("iter","state"))
pdf("FigS7_Priors_Posteriors_byState_06-20.pdf")
for (statenow in statesarr) { 
  p<-ggplot(subset(allparms.df,state==statenow),aes(x=value)) +
      geom_histogram(aes(y=..density..,fill="Posterior")) +
      geom_density(aes(fill="Prior"),alpha=0.6, 
                   data=subset(allpriors.df,state==statenow)) + 
    theme_bw()+theme(legend.position = "bottom")+
    guides(fill = guide_legend(reverse = TRUE))+
    labs(fill="")+ggtitle(statenow)+
    scale_fill_viridis_d(begin=0,end=0.8,option="magma")+
    facet_wrap(~variable,scales="free")
  print(p)
}
dev.off()
```

```{r reopening at 2020-06-20, echo=FALSE,fig.height=2,fig.width=6}
# preopen <- ggplot(allparms)+
#   geom_col(aes(x=state,y=100*ReopenPct,fill=Category),data=allparms.med)+
#   geom_boxplot(aes(x=state,y=100*ReopenPct),alpha=0,outlier.shape = NA)+
#   scale_fill_viridis_d(begin=0.9,end=0.5,option="magma")+xlab("")+
#   #ylim(0,100)+
#   ylab("Reopening %")+
#   labs(fill="Category based on IQR")+
#   theme_bw()+theme(legend.position="bottom")+
# #  geom_text(aes(x=state,y=0.02+Prediction.97.5.,label=Date,angle=90),hjust=0,size=2)+
#   ggtitle("Reopening Percentage estimated 2020-06-20")
# print(preopen)
# ggsave("Reopen.2020.06.20.pdf",plot=preopen,height=2,width=6,scale=1.75)
```

```{r hygiene at 2020-06-20, echo=FALSE,fig.height=2,fig.width=6}
# 
# phygiene <- ggplot(allparms)+
#   geom_col(aes(x=state,y=100*(HygieneFit-1),fill=Category),data=allparms.med)+
#   geom_boxplot(aes(x=state,y=100*(HygieneFit-1)),alpha=0,outlier.shape = NA)+
#   scale_fill_viridis_d(begin=0.9,end=0.5,option="magma")+xlab("")+
#   ylim(-100,0)+
#   ylab("% Reduction")+
#   labs(fill="Category based on IQR")+
#   theme_bw()+theme(legend.position="bottom")+
#   ggtitle("Hygiene-related mitigation estimated 2020-06-20")
# print(phygiene)
# ggsave("Hygiene.2020.06.20.pdf",plot=phygiene,height=2,width=6,scale=1.75)
```

```{r reopening and hygiene at 2020-06-20, echo=FALSE,fig.height=2,fig.width=6}
# 
# preopenhygiene <- ggplot(allparms)+
#   geom_col(aes(x=state,y=100*(HygieneFit-1),fill=Category),data=allparms.med)+
#   geom_boxplot(aes(x=state,y=100*(HygieneFit-1)),alpha=0,outlier.shape = NA)+
#   geom_col(aes(x=state,y=100*ReopenPct,fill=Category),data=allparms.med)+
#   geom_boxplot(aes(x=state,y=100*ReopenPct),alpha=0,outlier.shape = NA)+
#   geom_hline(yintercept=0,color="grey50")+
#   scale_fill_viridis_d(begin=0.9,end=0.5,option="magma")+xlab("")+
#   ylim(-100,NA)+ylab("%")+
#   labs(fill="Category based on IQR")+
#   theme_bw()+theme(legend.position="bottom")+
#   ggtitle("Reopening (+) and Hygiene-related mitigation (-) estimated 2020-06-20")
# print(preopenhygiene)
# ggsave("ReopenHygiene.2020.06.20.pdf",plot=preopenhygiene,height=2,width=6,scale=1.75)
```

```{r 3 way combined figures,echo=FALSE,fig.height=6,fig.width=6}
# 
# figRv1<-ggarrange(pReffShelter,pReffnow,preopen,
#                   nrow=3,heights=c(2,2,1),labels = c("A", "B","C"))
# print(figRv1)
# ggsave("FigRv1.pdf",plot=figRv1,height=6,width=6,scale=1.75)
# 
# figRv2<-ggarrange(pReffMin,pReffnow,preopen,
#                   nrow=3,heights=c(2,2,1),labels = c("A", "B","C"))
# print(figRv2)
# ggsave("FigRv2.pdf",plot=figRv2,height=6,width=6,scale=1.75)
```



```{r 2 way combined figures,echo=FALSE,fig.height=6,fig.width=6}

# figRv3<-ggarrange(pReffcombreopen,preopen,
#                   nrow=2,heights=c(3,1),labels = c("A", "B"))
# print(figRv3)
# ggsave("FigRv3.pdf",plot=figRv3,height=6,width=6,scale=1.75)
# 
# figRv4<-ggarrange(pReffcombmin,preopen,
#                   nrow=2,heights=c(3,1),labels = c("A", "B"))
# print(figRv4)
# ggsave("FigRv4.pdf",plot=figRv4,height=6,width=6,scale=1.75)
```

```{r 3 way combined figures with hygiene,echo=FALSE,fig.height=6,fig.width=6}

# figRv5<-ggarrange(pReffcombreopen,preopen,phygiene,
#                   nrow=3,heights=c(3,1,1),labels = c("A", "B","C"))
# print(figRv5)
# ggsave("FigRv5.pdf",plot=figRv5,height=6,width=6,scale=1.75)
# 
# figRv6<-ggarrange(pReffcombmin,preopen,phygiene,
#                   nrow=3,heights=c(3,1,1),labels = c("A", "B","C"))
# print(figRv6)
# ggsave("FigRv6.pdf",plot=figRv6,height=6,width=6,scale=1.75)
```

```{r 2 way combined figures with hygiene,echo=FALSE,fig.height=6,fig.width=6}

# figRv7<-ggarrange(pReffcombreopen,preopenhygiene,
#                   nrow=2,heights=c(3,1),labels = c("A", "B"))
# print(figRv7)
# ggsave("FigRv7.pdf",plot=figRv7,height=6,width=6,scale=1.75)
# 
# figRv8<-ggarrange(pReffcombmin,preopenhygiene,
#                   nrow=2,heights=c(3,1),labels = c("A", "B"))
# print(figRv8)
# ggsave("FigRv8.pdf",plot=figRv8,height=6,width=6,scale=1.75)
```



```{r safe maps,echo=FALSE,fig.height=6,fig.width=6}
folder <- "../SEIR.reopen.state.alt2.2020.06.20"
numDate <- as.numeric(as.Date("2020-06-20"))-as.numeric(as.Date(datezero))
t <- numDate
if (file.exists("scenparms_OneTime-alt2.2020-06-20.RData")) load("scenparms_OneTime-alt2.2020-06-20.RData") else {
  scenparms <- data.frame()
  for (statenow in statesarr) { 
    sampfile <- list.files(path=file.path(folder,statenow),
                             pattern="*OneTime.out",
                           full.names=TRUE)
    parms <- read.delim(sampfile,as.is=TRUE,sep="\t")
    names(parms)<-gsub("_1.1","",names(parms))
    names(parms)<-gsub("GM_","",names(parms))
    parms$state <- factor(statenow,levels=(sort(statesarr)))
    
    ## Time dependent parameters, evaluated at last day
    parms$ThetaFit <- (parms$ThetaMin - 
                          (parms$ThetaMin - 1)*
                          exp(-((t-60)/parms$TauTheta)^parms$PwrTheta));
    ## Reopening - increase contacts/day
    parms$TimeReopen = 60+parms$TauTheta+parms$TauS;
    parms$ReopenStart = (1 - 1/(1 + exp(4*(t - parms$TimeReopen))));
    parms$ReopenStop =  (1 - 1/(1 + exp(4*(t - (parms$TimeReopen+parms$TauR)))));
    parms$ReopenPct = ((t - parms$TimeReopen)*(parms$rMax/parms$TauR)*(parms$ReopenStart-parms$ReopenStop)+parms$rMax*parms$ReopenStop);
    ## Contacts/day
    parms$c = parms$c0 * (parms$ThetaFit + (1 - parms$ThetaMin) * parms$ReopenPct); 
    ## Hygiene - reduce infection probability/infected contact
    parms$HygieneFit <- parms$ThetaFit^parms$HygienePwr;
    parms$beta <- parms$beta0 * parms$HygieneFit; # infection probability/infected contact
    parms$Delta <- (parms$c*parms$beta -
                              parms$c0*parms$beta0*
                              parms$ThetaMin^(1+parms$HygienePwr))/
    (parms$c0*parms$beta0 -
       parms$c0*parms$beta0*
       parms$ThetaMin^(1+parms$HygienePwr))
    ## Time dependence of testing/contact tracting
    parms$TestingTimeDep <- (1-1/(1+exp((t-parms$TStartTesting)/parms$TauTesting))); 
    ## Contact tracing
    parms$FTraced <- parms$FracTraced * parms$TestingTimeDep;
    ## Testing
    parms$lambda <- parms$TestingTimeDep * parms$lambda0; 
    parms$lambda_C <- parms$TestingTimeDep * parms$lambda0_C; 
    parms$rho_C <- parms$TestingTimeDep * parms$rho0_C;
    parms$fracpos = parms$FTraced*parms$lambda_C/(parms$lambda_C + parms$rho_C)+(1-parms$FTraced)*parms$lambda/(parms$lambda+parms$rho); # fraction of infected that are tested and positive
    ## Case fatality
    parms$fracposmin <- parms$IFR / 0.9; # max 90% of cases fatal
    parms$CFR <- ifelse(parms$fracpos > parms$fracposmin, parms$IFR/parms$fracpos, 0.9); # Adjust infected fatality to (tested) case fatality
    parms$delta <- parms$rho * parms$CFR/(1-parms$CFR);
    scenparms <- rbind(scenparms,parms)
  }
  scenparms.med<-aggregate(.~state,data=scenparms,median)
}

ftraceloggrid<-10^seq(-2,0,0.01)
lambdaloggrid<-10^seq(-2,-0.3,0.01)
if (file.exists("f_lambda_safemap-alt2.2020-06-20.RData")) load("f_lambda_safemap-alt2.2020-06-20.RData") else {
  gg.df <- data.frame()
  for (statenow in statesarr) {
    parms<-subset(scenparms,state==statenow)
    gg <- expand.grid(FTraced=ftraceloggrid,lambda=lambdaloggrid)
    gg$PrRle1<-0
    for (j in 1:nrow(gg)){
      fscale <- gg$FTraced[j]/median(parms$FTraced)
      lscale <- gg$lambda[j]/median(parms$lambda)
      Refft <- parms$R0*parms$S*parms$rho*(1-parms$FTraced*fscale)*
        parms$HygieneFit*parms$c/parms$c0/(parms$rho+parms$lambda*lscale)
      gg$PrRle1[j] <- ecdf(Refft)(1)
    }
    gg$state<-statenow
    gg.df<-rbind(gg.df,gg)
  }
}

# ptest<-ggplot(gg,aes(x=FTraced,y=lambda)) +
#   geom_tile(aes(fill=PrRle1))+
#   scale_fill_viridis_c("Probability R[eff](t)<1",begin = 0.4,option="magma")+
#   scale_x_log10(expand=c(0,0.02))+
#   scale_y_log10(expand=c(0,0.02))+
#   stat_contour(aes(z=PrRle1),
#                breaks=c(0.025,0.5,0.975))+
#   geom_label_contour(aes(z=PrRle1),
#                breaks=c(0.025,0.5,0.975))+
#   geom_point(aes(x=median(FTraced),y=median(lambda),fill=median(Refft),
#                  color=""),shape=21,data=parms)+
#   scale_color_viridis_d(option="plasma")+
#   labs(fill=bquote(paste("Pr ",R[eff](t)<1)), color="Current Parameters")+
#   xlab(bquote(paste(f[C]," = Fraction of Contacts Traced")))+
#   ylab(bquote(lambda == Coverage %*% Sensitivity %*% TestingRate))+
#   annotation_logticks()+
#   theme(legend.position = "bottom",axis.text.x = element_text(angle = 90))
# print(ptest)

pall<-ggplot(gg.df,aes(x=FTraced,y=lambda)) +
  geom_tile(aes(fill=PrRle1))+
  scale_fill_viridis_c("Probability R[eff](t)<1",begin = 0.4,option="magma")+
  scale_x_log10(expand=c(0,0.02))+
  scale_y_log10(expand=c(0,0.02))+
  stat_contour(aes(z=PrRle1),
               breaks=c(0.025,0.5,0.975))+
  geom_label_contour(aes(z=PrRle1),label.padding=unit(0.05,"lines"),
               breaks=c(0.025,0.5,0.975),size=3,alpha=0.5)+
  geom_point(aes(x=FTraced,y=lambda,color=""),
             fill="white",shape=21,data=scenparms.med,size=2)+
  scale_color_viridis_d(begin=0,end=0)+
  labs(fill=bquote(paste("Pr ",R[eff](t)<1)), color="Current Parameters")+
  xlab(bquote(paste(f[C]," = Fraction of Contacts Traced")))+
  ylab(bquote(lambda == Coverage %*% Sensitivity %*% TestingRate))+
  annotation_logticks()+
  facet_wrap(~state)+
  theme(legend.position = "bottom",axis.text.x = element_text(angle = 90))
print(pall)

ggsave("FigS9_fC_lambda_Contour.pdf",plot=pall,height=6,width=6,scale=1.5)
ggsave("FigS9_fC_lambda_Contour.jpeg",plot=pall,height=6,width=6,scale=1.5)
save(scenparms,scenparms.med,file="scenparms_OneTime-alt2.2020-06-20.RData")
save(gg.df,file="f_lambda_safemap-alt2.2020-06-20.RData")
```
```{r dItot vs. dI}
if (file.exists("scenparms_OneTime-alt2.2020-06-20.RData")) load("scenparms_OneTime-alt2.2020-06-20.RData")

scenparms<-scenparms[,!duplicated(names(scenparms))]
scenparms$dIdIT <- scenparms$kappa * (scenparms$E + scenparms$E_C)/
  (scenparms$I_U * scenparms$lambda + 
     scenparms$I_C * scenparms$lambda_C)
pdIdIT<-ggplot(scenparms) + 
  geom_boxplot(aes(x=state,y=dIdIT),outlier.shape = NA)+
  scale_y_log10()+annotation_logticks(sides = "l")+
  ylab("Daily New Infections/Daily Positive Tests")+
  theme_bw()
print(pdIdIT)
ggsave("DailyInfections_PosTests.pdf",
       plot=pdIdIT,height=3,width=6,scale=1.75)

scenparms$CumICumT <- (scenparms$I_U+scenparms$I_C+scenparms$I_T+
                         scenparms$R_U+scenparms$R_T+scenparms$F_T)/
  (scenparms$I_T+scenparms$R_T+scenparms$F_T)
pCumICumT<-ggplot(scenparms) + 
  geom_boxplot(aes(x=state,y=CumICumT),outlier.shape = NA)+
  scale_y_log10()+annotation_logticks(sides = "l")+
  ylab("Cumulative Infections/Positive Tests")+
  theme_bw()
print(pCumICumT)
ggsave("CumulativeInfections_PosTests.pdf",
       plot=pCumICumT,height=3,width=6,scale=1.75)

pftraced <- ggplot(scenparms)+
  geom_boxplot(aes(x=state,y=FTraced),outlier.shape = NA)+
  scale_y_log10()+annotation_logticks(sides = "l")+
  ylab("Fraction Traced")+
  theme_bw()
print(pftraced)
ggsave("FractionTraced.pdf",
       plot=pftraced,height=3,width=6,scale=1.75)

```

```{r Delta crit,echo=FALSE,fig.height=3,fig.width=6}
if (file.exists("scenparms_OneTime-alt2.2020-06-20.RData")) load("scenparms_OneTime-alt2.2020-06-20.RData")
scenparms<-scenparms[,!duplicated(names(scenparms))]
  
Deltacritfunc<-function(scenparms,fscale=1,lscale=1) {
  ftracescaled<-scenparms$FTraced*fscale
  ftracescaled[ftracescaled>0.99]<-0.99
  Deltacrit<-((scenparms$rho+scenparms$lambda*lscale)/
             (scenparms$S*scenparms$c0*scenparms$beta0*
                (1-ftracescaled)) - 
            scenparms$ThetaMin^(1+scenparms$HygienePwr))/
    (1 - scenparms$ThetaMin^(1+scenparms$HygienePwr))
  Deltacrit[Deltacrit>1]<-1
  return(Deltacrit)
}
scenparms$Deltacrit.1.1 <- Deltacritfunc(scenparms,fscale=1,lscale=1)
scenparms$Deltacrit.1.2 <- Deltacritfunc(scenparms,fscale=1,lscale=2)
scenparms$Deltacrit.2.1 <- Deltacritfunc(scenparms,fscale=2,lscale=1)
scenparms$Deltacrit.2.2 <- Deltacritfunc(scenparms,fscale=2,lscale=2)

scenparms.med<-aggregate(.~state,data=scenparms,median)
scenparms$Category <- fips_table[as.character(scenparms$state),"RtCategory"]
scenparms.med$Category <- fips_table[as.character(scenparms.med$state),"RtCategory"]

dftmp<-melt(as.data.table(scenparms),id.vars=c("state","Category","Delta"),
            measure.vars = c("Deltacrit.1.1",
                             "Deltacrit.1.2","Deltacrit.2.1","Deltacrit.2.2"),
            variable.factor = FALSE)
dftmp$variable[dftmp$variable=="Deltacrit.1.1"]<-"Delta[crit](1,1)"
dftmp$variable[dftmp$variable=="Deltacrit.1.2"]<-"Delta[crit](1,2)"
dftmp$variable[dftmp$variable=="Deltacrit.2.1"]<-"Delta[crit](2,1)"
dftmp$variable[dftmp$variable=="Deltacrit.2.2"]<-"Delta[crit](2,2)"

dftmp.med<-melt(as.data.table(scenparms.med),id.vars=c("state","Category","Delta"),
            measure.vars = c("Deltacrit.1.1",
                             "Deltacrit.1.2","Deltacrit.2.1","Deltacrit.2.2"),
            variable.factor = FALSE)
dftmp.med$variable[dftmp.med$variable=="Deltacrit.1.1"]<-"Delta[crit](1,1)"
dftmp.med$variable[dftmp.med$variable=="Deltacrit.1.2"]<-"Delta[crit](1,2)"
dftmp.med$variable[dftmp.med$variable=="Deltacrit.2.1"]<-"Delta[crit](2,1)"
dftmp.med$variable[dftmp.med$variable=="Deltacrit.2.2"]<-"Delta[crit](2,2)"

dflabs<-c("Baseline","2X testing",
                          "2X contact tracing","2X testing and contact tracing")
names(dflabs)<-c("Delta[crit](1,1)","Delta[crit](1,2)","Delta[crit](2,1)","Delta[crit](2,2)")

p<-ggplot(data=dftmp,
       aes(x=state,
           y=100*value,fill=Category
           #,color=variable
           )) + 
  geom_boxplot(outlier.shape = NA,position="dodge")+
  #geom_col(data=dftmp.med,position="dodge")+
  #scale_color_viridis_d(begin=0.9,end=0.5,option="magma")+
  scale_fill_viridis_d(begin=0.9,end=0.5,option="magma",
                       labels=list(bquote(R[eff](t)<1),
                                   bquote(R[eff](t)%~~%1),
                                   bquote(R[eff](t)>1)))+
  #coord_cartesian(ylim=c(0,100))+
  scale_y_continuous(breaks=seq(-25,100,25))+
  ylab(bquote(Delta[crit]))+
  labs(fill="",color="",shape="")+
  theme_bw()+theme(legend.position="bottom"
        #            ,
        #            axis.title.x=element_blank(),
        # axis.text.x=element_blank(),
        # axis.ticks.x=element_blank()
        )+
  geom_hline(yintercept=0)+
  #ggtitle(bquote(paste(Delta[crit](mu[lambda],mu[C]),": Critical % reopening to keep ",R[eff](t)<1)))+
  facet_wrap(~variable,ncol=1,
             labeller = labeller(variable=dflabs))
print(p)
ggsave("Fig3_Deltacrit.pdf",plot=p,height=4,width=6,scale=1.75)
ggsave("Fig3_Deltacrit.jpeg",plot=p,height=4,width=6,scale=1.75)
p2<-p+geom_point(aes(x=state,y=100*Delta,shape="Delta(t)",fill=Category),
                 data=dftmp.med)+
  scale_shape_manual(values=21,
                     labels=as.expression(bquote(Delta(t==2020-06-20))))
print(p2)
ggsave("Fig3_DeltacritDeltaCurrent.pdf",plot=p2,height=4,width=6,scale=1.75)
ggsave("Fig3_DeltacritDeltaCurrent.jpeg",plot=p2,height=4,width=6,scale=1.75)
```


```{r safe reopening,echo=FALSE,fig.height=3,fig.width=6}
# if (file.exists("scenparms_OneTime-2020-06-20.RData")) load("scenparms_OneTime-2020-06-20.RData")
# scenparms<-scenparms[,!duplicated(names(scenparms))]
# 
# rcritfunc<-function(scenparms,fscale=1,lscale=1) {
#   rcrit<-(((scenparms$rho+scenparms$lambda*lscale)/(1-scenparms$FTraced*fscale))/
#     (scenparms$beta*scenparms$S*scenparms$c0) - 
#       scenparms$ThetaFit)/
#     (1-scenparms$ThetaMin)
#   return(rcrit)
# }
# scenparms$rcrit.1.1 <- rcritfunc(scenparms,fscale=1,lscale=1)
# scenparms$rcrit.2.1 <- rcritfunc(scenparms,fscale=2,lscale=1)
# scenparms$rcrit.1.2 <- rcritfunc(scenparms,fscale=1,lscale=2)
# scenparms$rcrit.2.2 <- rcritfunc(scenparms,fscale=2,lscale=2)
# 
# scenparms.med<-aggregate(.~state,data=scenparms,median)
# scenparms$Category <- fips_table[as.character(scenparms$state),"RtCategory"]
# scenparms.med$Category <- fips_table[as.character(scenparms.med$state),"RtCategory"]
# 
# dftmp<-melt(as.data.table(scenparms),id.vars=c("state","Category"),
#             measure.vars = c("ReopenPct","rcrit.1.1",
#                              "rcrit.1.2","rcrit.2.1","rcrit.2.2"),
#             variable.factor = FALSE)
# dftmp$variable[dftmp$variable=="ReopenPct"]<-"r(t)"
# dftmp$variable[dftmp$variable=="rcrit.1.1"]<-"rcrit(1,1)"
# dftmp$variable[dftmp$variable=="rcrit.1.2"]<-"rcrit(1,2)"
# dftmp$variable[dftmp$variable=="rcrit.2.1"]<-"rcrit(2,1)"
# dftmp$variable[dftmp$variable=="rcrit.2.2"]<-"rcrit(2,2)"
# dftmp.med<-melt(as.data.table(scenparms.med),id.vars=c("state","Category"),
#             measure.vars = c("ReopenPct","rcrit.1.1",
#                              "rcrit.1.2","rcrit.2.1","rcrit.2.2"),
#             variable.factor = FALSE)
# dftmp.med$variable[dftmp.med$variable=="ReopenPct"]<-"r(t)"
# dftmp.med$variable[dftmp.med$variable=="rcrit.1.1"]<-"rcrit(1,1)"
# dftmp.med$variable[dftmp.med$variable=="rcrit.1.2"]<-"rcrit(1,2)"
# dftmp.med$variable[dftmp.med$variable=="rcrit.2.1"]<-"rcrit(2,1)"
# dftmp.med$variable[dftmp.med$variable=="rcrit.2.2"]<-"rcrit(2,2)"
# p<-ggplot(data=dftmp,
#        aes(x=state,
#            y=100*value,fill=variable
#            #,color=variable
#            )) + 
#   geom_boxplot(outlier.shape = NA,position="dodge")+
#   #geom_col(data=dftmp.med,position="dodge")+
#   #scale_color_viridis_d(begin=0.9,end=0.5,option="magma")+
#   scale_fill_viridis_d(begin=0.9,end=0.5,option="magma")+
#   #coord_cartesian(ylim=c(0,150))+
#   ylim(0,150)+
#   ylab(bquote(paste(r(t)," or ",r[crit])))+
#   labs(fill="",color="")+
#   theme_bw()+theme(legend.position="bottom",
#                    axis.title.x=element_blank(),
#         axis.text.x=element_blank(),
#         axis.ticks.x=element_blank())+
#   geom_hline(yintercept=c(0,100))+
#   facet_wrap(~state,scales="free_x")+
#   ggtitle(bquote(paste("r(t): Current % reopening; ",r[crit](mu[lambda],mu[C]),": Critical % reopening to keep ",R[eff](t)<1)))
# 
# ggsave("Figrcrit.pdf",plot=p,height=6,width=6,scale=1.5)
```



## Validation 

Calibration using data until April 30? validation with data through June 20.

```{r load results, echo=FALSE, include=FALSE}
folder <- "../SEIR.reopen.alt2.2020.04.30"
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code
fips_table$Region <- "South"
fips_table$Region[fips_table$Alpha.code %in% c("CT","ME","MA","NH","RI",
                                               "VT","NJ","NY","PA")] <- "Northeast"
fips_table$Region[fips_table$Alpha.code %in% c("IL","IN","MI","OH","WI","IA",
                                               "KS","MN","MO","NE","ND","SD")] <- "Midwest"
fips_table$Region[fips_table$Alpha.code %in% c("AZ","CO","ID","MT","NV","NM","UT","WY",
                                               "AK","CA","HI","OR","WA")] <- "West"

statesarr <- fips_table$Alpha.code[2:52]
## Read prediction files
allcalvaldat <- data.frame()
for (statenow in statesarr) { 
  csvfile <- list.files(path=file.path(folder,statenow),
                           pattern="*prediction.quantiles.csv",
                         full.names=TRUE)
  calvaldat <- read.csv(csvfile,as.is=TRUE)
  calvaldat$state <- statenow
  allcalvaldat <- rbind(allcalvaldat,calvaldat)
}
allcalvaldat$Output_Var[allcalvaldat$Output_Var=="N_pos"] <- "positiveIncrease"
allcalvaldat$Output_Var[allcalvaldat$Output_Var=="D_pos"] <- "deathIncrease"
allcalvaldat$Output_Var[allcalvaldat$Output_Var=="CumPos"] <- "positive"
allcalvaldat$Output_Var[allcalvaldat$Output_Var=="D_T"] <- "death"
allcalvaldat$Date <- as.Date(allcalvaldat$Time,origin=as.Date(datezero))

## Read data files
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"))
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"))
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

```

Example states: one from each major region of the US: New York (Northeast), Ohio (Midwest), Texas (South), and Washington (West).

```{r example states, echo=FALSE, fig.height=4.87,fig.width=4.4, fig.cap="Figure 1B (embedded as part of Figure 1). Validation runs: Model calibration (through April 30, 2020) and validation (through June 20, 2020) time-courses for selected States."}
egstates <- c("OH","NY","TX","WA")
calvaldat.df <- subset(allcalvaldat,state %in% egstates)

## Observed/predicted daily
obsdat.df<-subset(alldat.df,state %in% egstates & (
  Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
)) 

## Calibration vs. validation
datadatemax <- "2020-04-30"
novalid <- FALSE
validdate <- "2020-06-20"
obsdat.df$Calibration <- obsdat.df$Date <= datadatemax
calvaldat.df$Calibration <- calvaldat.df$Date <= datadatemax
obsdat.df$Calibration <- factor(ifelse(obsdat.df$Calibration,
                                       "Train","Validate"),
                                levels=c("Train","Validate"))

calvaldat.df$Calibration <- factor(ifelse(calvaldat.df$Calibration,
                                        "Train","Validate"),
                                levels=c("Train","Validate"))

if (novalid) {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(datadatemax))
  calvaldat.df <- subset(calvaldat.df,Date <= as.Date(datadatemax))
} else {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(validdate))
  calvaldat.df <- subset(calvaldat.df,Date <= as.Date(validdate))
}
obsnames <- c("Daily reported cases","Daily confirmed deaths")
names(obsnames) <- c("positiveIncrease","deathIncrease")

calvaldat.df$Prediction.2.5.[calvaldat.df$Prediction.2.5.<0.1]<-0.1
calvaldat.df$Prediction.25.[calvaldat.df$Prediction.25.<0.1]<-0.1
calvaldat.df$Prediction.50.[calvaldat.df$Prediction.50.<0.1]<-0.1
calvaldat.df$Prediction.75.[calvaldat.df$Prediction.75.<0.1]<-0.1
calvaldat.df$Prediction.97.5.[calvaldat.df$Prediction.97.5.<0.1]<-0.1

p<-ggplot(subset(calvaldat.df,Output_Var=="positiveIncrease" | Output_Var=="deathIncrease"))+
  geom_col(aes(x=Date,y=Data,
                             alpha=Calibration),data=obsdat.df)+
  geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                  fill="CrI",alpha=Calibration))+
  geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                  fill="IQR",alpha=Calibration))+
  geom_line(aes(x=Date,y=Prediction.50.,linetype="Median",
                             alpha=Calibration))+
  ylab("")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
  scale_x_date(date_minor_breaks = "1 day")+
  facet_wrap(~state*Output_Var,ncol=2,
                  labeller = labeller(Output_Var = obsnames),
                scales="free_y")+
     # facet_grid(state~Output_Var,
     #              labeller = labeller(Output_Var = obsnames),
     #            scales="free_y")+
  theme_bw()+theme(legend.position = "bottom",
                   strip.text = element_text(size=6,
                                             margin = 
                                               margin(.05, 0, .05, 0, "cm"))) + 
        scale_alpha_discrete(range=rev(c(0.4,0.8)))+
              geom_vline(xintercept=as.Date(datadatemax)+1,
                         linetype="dotted",color="black") +
  #scale_y_log10(breaks=10^(0:10))+
        #annotation_logticks(sides="l")+
        labs(fill="",linetype="Prediction",alpha="Dataset")+
        guides(alpha = guide_legend(order = 1,nrow=2),
         linetype = guide_legend(order = 2),
         fill = guide_legend(order = 3,nrow=2))


print(p)
ggsave("Fig1B.pdf",plot=p,height=4.87,width=4.4,scale=1.1)
ggsave("Fig1B.png",plot=p,height=4.87,width=4.4,scale=1.1)
ggsave("Fig1B.jpeg",plot=p,height=4.87,width=4.4,scale=1.1)

plog <- p+scale_y_log10(breaks=10^(0:10))+annotation_logticks(sides="l")+  
  coord_cartesian(ylim=c(1,10000))+
  facet_wrap(~state*Output_Var,ncol=2,
                  labeller = labeller(Output_Var = obsnames))
print(plog)
ggsave("Fig1Blog.pdf",plot=plog,height=4.87,width=4.4,scale=1.1)
ggsave("Fig1Blog.png",plot=plog,height=4.87,width=4.4,scale=1.1)
ggsave("Fig1Blog.jpeg",plot=plog,height=4.87,width=4.4,scale=1.1)
```


```{r model, echo=FALSE,fig.cap="Figure 1. SEIR model structure."}
# include_graphics("Figure1.png")
```


Next are scatter plots showing overall calibration and validation of model.

```{r scatter plot, echo=FALSE, fig.height=6, fig.width=8.5, fig.cap="Figure S-1. Validation runs: Comparison of data and predictions overall."}
calvaldat.df <- allcalvaldat

## Observed/predicted daily
obsdat.df<-subset(alldat.df,
  Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
)

## Calibration vs. validation
datadatemax <- "2020-04-30"
novalid <- FALSE
validdate <- "2020-06-20"
obsdat.df$Calibration <- obsdat.df$Date <= datadatemax
calvaldat.df$Calibration <- calvaldat.df$Date <= datadatemax
if (novalid) {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(datadatemax))
  calvaldat.df <- subset(calvaldat.df,Date <= as.Date(datadatemax))
} else {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(validdate))
  calvaldat.df <- subset(calvaldat.df,Date <= as.Date(validdate))
}
obsnames <- c("Daily reported cases","Daily confirmed deaths")
names(obsnames) <- c("positiveIncrease","deathIncrease")

predobs.df <- merge(obsdat.df,calvaldat.df,all.x=TRUE)
predobs.df$DataSet <- ifelse(predobs.df$Calibration,
                             "Calibration","Validation")

likeCIdeath <- data.frame(Data=c(0.1,0.3,seq(1,
                                   max(subset(predobs.df,
                                              Output_Var=="deathIncrease"
                                              )$Data)),1000,3000,10000,20000))
likeCIdeath$Prediction.50. <- likeCIdeath$Data
likeCIdeath$Prediction.2.5. <- qnbinom(0.025,size=8,
                                       prob=8/(8+likeCIdeath$Data))
likeCIdeath$Prediction.97.5. <- qnbinom(0.975,size=8,
                                       prob=8/(8+likeCIdeath$Data))
likeCIdeath$Output_Var<-"deathIncrease"

likeCIpositive <- data.frame(Data=c(0.1,0.3,seq(1,
                                   max(subset(predobs.df,
                                              Output_Var=="positiveIncrease"
                                              )$Data)),20000))
likeCIpositive$Prediction.50. <- likeCIpositive$Data
likeCIpositive$Prediction.2.5. <- qnbinom(0.025,size=4,
                                       prob=4/(4+likeCIpositive$Data))
likeCIpositive$Prediction.97.5. <- qnbinom(0.975,size=4,
                                       prob=4/(4+likeCIpositive$Data))
likeCIpositive$Output_Var<-"positiveIncrease"
likeCI<-rbind(likeCIpositive,likeCIdeath)
likeCI$DataSet <- "Calibration"
likeCI.tmp <- likeCI
likeCI$DataSet <- "Validation"
likeCI <- rbind(likeCI, likeCI.tmp)

figS1<-ggplot(predobs.df)+
  geom_pointrange(aes(x=Data,y=Prediction.50.,
                      ymin=Prediction.2.5.,
                      ymax=Prediction.97.5.,
                      color=state,group=state),
                  position=position_jitter(width=0.1))+
  geom_ribbon(data=likeCI,
              aes(x=Data,ymin=Prediction.2.5.,
                      ymax=Prediction.97.5.,fill="CrI"),alpha=0.4)+
  geom_abline(slope=1,intercept=0)+
  scale_fill_viridis_d(option="magma",begin = 0.95,end=0.95)+
  scale_color_viridis_d()+
  coord_cartesian(xlim=c(0.1,20000),ylim=c(0.1,20000))+
  scale_x_log10()+
  scale_y_log10()+facet_grid(DataSet~Output_Var,labeller = labeller(Output_Var=obsnames))+
  ylab("Prediction (95% CrI)")+guides(fill = "none")+
  theme_bw()+
  annotation_logticks()
print(figS1)
ggsave("FigS1.pdf",plot=figS1,height=6,width=8,scale=1.5)
ggsave("FigS1.jpeg",plot=figS1,height=6,width=8,scale=1.5)
```

Each panel shows data versus predictions for daily deaths (left column) or cases (right column), with calibration results shown in the top panels (through April 1) and validation results in the bottom panels (through April 30).  Each point includes the 95% CrI for the prediction. The band centered on the y=x line shows the additional 95% CrI for the negative binomial likelihood, which is used to account for day-to-day variation in reporting.

## Prediction

Full calibration through June 20


Again, time-courses for the four example states.

```{r example states full pred, echo=FALSE, fig.cap="Figure S-2. Model calibration through June 20, 2020: time-courses for selected States."}
egstates <- c("OH","NY","TX","WA")
preddat.df <- subset(allpreddat,state %in% egstates)

## Observed/predicted daily
obsdat.df<-subset(alldat.df,state %in% egstates & (
  Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
)) 

## Calibration vs. validation
datadatemax <- "2020-06-20"
novalid <- TRUE
validdate <- "2020-06-20"
if (novalid) {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(datadatemax))
  preddat.df <- subset(preddat.df,Date <= as.Date(datadatemax))
} else {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(validdate))
  preddat.df <- subset(preddat.df,Date <= as.Date(validdate))
}
obsnames <- c("Daily reported cases","Daily confirmed deaths")
names(obsnames) <- c("positiveIncrease","deathIncrease")

p<-ggplot(subset(preddat.df,Output_Var=="positiveIncrease" | Output_Var=="deathIncrease"))+
  geom_col(aes(x=Date,y=Data),data=obsdat.df)+
        #geom_vline(aes(xintercept=as.Date(datadatemax)),color="grey",show.legend=FALSE)+
        scale_alpha_discrete(range=c(0.4,1))+
  geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                  fill="CrI"))+
  geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                  fill="IQR"))+
  geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
  ylab("")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
  scale_x_date(date_minor_breaks = "1 day")+
  facet_wrap(~state*Output_Var,ncol=2,
                  labeller = labeller(Output_Var = obsnames),
                scales="free_y")+
  theme_bw()+theme(legend.position = "bottom",
                   strip.text = element_text(size=6,
                                             margin = 
                                               margin(.05, 0, .05, 0, "cm")))

FigS5<-(p + 
          #scale_y_log10(breaks=10^(0:10),limits=c(0.1,NA))+
          #annotation_logticks(sides="l")+
        guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2))+
        labs(fill="",linetype="Prediction")+theme_bw()+theme(legend.position = "bottom"))
        
print(FigS5)
ggsave("FigS5_06_20.pdf",plot=FigS5,height=4.87,width=4.4,scale=1.75)
ggsave("FigS5_06_20.jpeg",plot=FigS5,height=4.87,width=4.4,scale=1.75)
```

Again, scatter plots showing overall calibration accuracy.

```{r scatter plot full pred, echo=FALSE, fig.height=3.5, fig.width=8,fig.cap="Figure S-3. Model calibration through June 20, 2020: comparisons of data and predictions for all States."}
preddat.df <- allpreddat

## Observed/predicted daily
obsdat.df<-subset(alldat.df,
  Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
)

## Calibration vs. validation
datadatemax <- "2020-06-20"
novalid <- TRUE
validdate <- "2020-06-20"
if (novalid) {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(datadatemax))
  preddat.df <- subset(preddat.df,Date <= as.Date(datadatemax))
} else {
  obsdat.df <- subset(obsdat.df,Date <= as.Date(validdate))
  preddat.df <- subset(preddat.df,Date <= as.Date(validdate))
}
obsnames <- c("Daily reported cases","Daily confirmed deaths")
names(obsnames) <- c("positiveIncrease","deathIncrease")

predobs.df <- merge(obsdat.df,preddat.df,all.x=TRUE)

likeCIdeath <- data.frame(Data=c(0.1,0.3,seq(1,
                                   max(subset(predobs.df,
                                              Output_Var=="deathIncrease"
                                              )$Data)),1000,3000,10000,50000))
likeCIdeath$Prediction.50. <- likeCIdeath$Data
likeCIdeath$Prediction.2.5. <- qnbinom(0.025,size=8,
                                       prob=8/(8+likeCIdeath$Data))
likeCIdeath$Prediction.97.5. <- qnbinom(0.975,size=8,
                                       prob=8/(8+likeCIdeath$Data))
likeCIdeath$Output_Var<-"deathIncrease"

likeCIpositive <- data.frame(Data=c(0.1,0.3,seq(1,
                                   max(subset(predobs.df,
                                              Output_Var=="positiveIncrease"
                                              )$Data)),50000))
likeCIpositive$Prediction.50. <- likeCIpositive$Data
likeCIpositive$Prediction.2.5. <- qnbinom(0.025,size=4,
                                       prob=4/(4+likeCIpositive$Data))
likeCIpositive$Prediction.97.5. <- qnbinom(0.975,size=4,
                                       prob=4/(4+likeCIpositive$Data))
likeCIpositive$Output_Var<-"positiveIncrease"
likeCI<-rbind(likeCIpositive,likeCIdeath)

FigS6<-ggplot(predobs.df)+
  geom_pointrange(aes(x=Data,y=Prediction.50.,
                      ymin=Prediction.2.5.,
                      ymax=Prediction.97.5.,
                      color=state,group=state),
                  position=position_jitter(width=0.1))+
  geom_ribbon(data=likeCI,
              aes(x=Data,ymin=Prediction.2.5.,
                      ymax=Prediction.97.5.,fill="CrI"),alpha=0.4)+
  geom_abline(slope=1,intercept=0)+
  scale_fill_viridis_d(option="magma",begin = 0.95,end=0.95)+
  scale_color_viridis_d()+
  coord_cartesian(xlim=c(0.1,50000),ylim=c(0.1,50000))+
  scale_x_log10()+
  scale_y_log10()+facet_grid(~Output_Var,labeller = labeller(Output_Var=obsnames))+
  ylab("Prediction (95% CrI)")+guides(fill = "none")+
  theme_bw()+
  annotation_logticks()
print(FigS6)
ggsave("FigS6_06_20.pdf",plot=FigS6,height=3.5,width=8,scale=1.5)
ggsave("FigS6_06_20.jpeg",plot=FigS6,height=3.5,width=8,scale=1.5)
```



The main contributors to variation in R(t) are theta and eta (contribute about 80% of variance by anova).  

```{r contributions to Rt,echo=FALSE,fig.height=4,fig.width=8,, fig.cap="Figure S-5. Correlations between R(t) and parameters."}

library(sensitivity)
Rtsens.pcc<-pcc(scenparms[,c("R0","HygienePwr","ThetaMin",
                                  "Delta","FracTraced","lambda","rho")],
    scenparms[,"Refft"], rank = FALSE, logistic = FALSE, nboot = 0, conf = 0.95)
print(Rtsens.pcc)

res<-lm(Refft~.,data=scenparms[,c("R0","HygienePwr","ThetaMin",
                                  "Delta","FracTraced","lambda","rho","Refft")])
print(summary(res))
print(anova(res))

# 
# # pS4A<-ggplot(allparms,aes(x=Rt,y=thetamin,color=state))+
# #   geom_point(alpha=0.3)+
# #   stat_ellipse()+
# #   geom_label(aes(label=state),data=allparms.med, label.size = 0.1)+
# #   scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2.5)+
# #   geom_vline(xintercept=1)+
# #   xlab("R(t)")+
# #   ylab(bquote(theta[min]))+
# #   theme(legend.position="none")
# 

phyg<-ggplot(scenparms,aes(x=Refft,y=HygieneFit,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(theta^eta))+
  theme(legend.position="none")

phygpwr<-ggplot(scenparms,aes(x=Refft,y=HygienePwr,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(eta))+
  theme(legend.position="none")

ptheta<-ggplot(scenparms,aes(x=Refft,y=ThetaMin,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(theta[min]))+
  theme(legend.position="none")

pDelta<-ggplot(scenparms,aes(x=Refft,y=Delta,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(Delta))+
  theme(legend.position="none")

preopen<-ggplot(scenparms,aes(x=Refft,y=rMax,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(r[max]))+
  theme(legend.position="none")

pfc<-ggplot(scenparms,aes(x=Refft,y=FracTraced,color=state))+
  geom_point(alpha=0.3)+
  stat_ellipse()+
  geom_label(aes(label=state),data=scenparms.med, label.size = 0.1)+
  scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2)+
  geom_vline(xintercept=1)+
  xlab(bquote(R[eff](t)))+
  ylab(bquote(f[C]))+
  theme(legend.position="none")

FigS8<-ggarrange(ptheta,phygpwr,
                 pDelta,pfc,
                 nrow=2,ncol=2,labels = c("A", "B","C","D"))
print(FigS8)
# 
# # pS4B<-ggplot(allparms,aes(x=Rt,y=lambda,color=state))+
# #   geom_point(alpha=0.3)+
# #   stat_ellipse()+
# #   geom_label(aes(label=state),data=allparms.med, label.size = 0.1)+
# #   scale_color_viridis_d(option="magma",end=0.8)+xlim(0,2.5)+
# #   geom_vline(xintercept=1)+
# #   xlab("R(t)")+
# #   ylab(bquote(theta[min]))+
# #   theme(legend.position="none")
# 
# # figS4<-ggarrange(pS4A,pS4B,nrow=1,labels = c("A", "B"))
# print(pcorr)
ggsave("FigS8_corr.pdf",plot=FigS8,height=6,width=6,scale=1.75)
ggsave("FigS8_corr.jpeg",plot=FigS8,height=6,width=6,scale=1.75)
```

## Testing-relaxation tradeoff

Increase in testing required to keep $R_t$<1 at 97.5% confidence at different levels of relaxation of restrictions. At beginning of May, the reproduction number with maximum social distancing is:

$$
R(t) = \frac{\beta \theta(t)_{min}^\eta}{\lambda+ \gamma}.
$$
Because social distancing is at a maximum, $\theta(t)$ is at its minimum $\theta_{min}$. We parameterize relaxation of social distancing by a term $\Delta$, where $\Delta=0$ is continued maximal social distancing, and $\Delta=1$ is complete relaxation of all restrictions. Similarly, we parameterize increased testing as a ``testing multiplier'' factor $\Omega$ by which $\lambda$ is increased.
Finally, by restricting $R_t<1$ we obtain the following equation for the tradeoff between testing and relaxation of restrictions:

$$
\frac{\beta [\theta_{min}^\eta + \Delta(1-\theta_{min}^\eta)]}
{\lambda\Omega+ \gamma} \leq 1
$$


One way to pose the policy question is how much "re-opening" (if any) is "safe."  Re-arranging the above equation in terms of $\Delta$ gives 

$$
\Delta \leq \Delta_{crit} = \frac{\lambda\Omega+\gamma-\beta\theta_{min}^\eta}{\beta(1-\theta_{min}^\eta)}
$$
For instance, given $\Omega=1$ (i.e., keeping current testing levels), we can derive the posterior for $\Delta_{crit}$ as the amount of relaxation (or, if negative, further restriction) needed to ensure $R(t)<1$.

```{r relax or restrict,echo=FALSE,fig.height=4,fig.width=6, fig.cap="Figure 3. Relaxation permitted or restriction required to keep R(t)<1 if (A) testing rate is unchanged, (B) testing rate is doubled, or (C) testing rate is tripled."}

# allparms$DeltaCrit <- 100*(allparms$lambda+allparms$gamma-
#                         allparms$beta*allparms$thetamin^allparms$eta)/
#   (allparms$beta - allparms$thetamin^allparms$eta)
# 
# allparms$lambdadouble <- 2*allparms$lambda
# allparms$DeltaCrit2 <- 100*(allparms$lambdadouble+allparms$gamma-
#                         allparms$beta*allparms$thetamin^allparms$eta)/
#   (allparms$beta - allparms$thetamin^allparms$eta)
# 
# allparms$lambdatriple <- 3*allparms$lambda
# allparms$DeltaCrit3 <- 100*(allparms$lambdatriple+allparms$gamma-
#                         allparms$beta*allparms$thetamin^allparms$eta)/
#   (allparms$beta - allparms$thetamin^allparms$eta)
# 
# 
# p3a<- ggplot(allparms, aes(x=state, y=DeltaCrit,fill=Category)) +
#   geom_hline(yintercept=1,size=1.5,alpha=0.6)+
#   stat_summary(fun.data = quantiles_95, geom="boxplot")+
#   scale_fill_viridis_d(begin=1,end=0.5,option="magma")+xlab("")+
#   ylab("")+
#   theme_bw()+theme(legend.position="bottom") +
#   labs(fill="Category based on IQR")+
#   scale_y_continuous(breaks = seq(-50,100,10))+
#   coord_cartesian(ylim=c(-50,100))+
#   geom_text(aes(x="AK",y=100,label="A: Testing Rate Unchanged"),hjust="left",vjust="top",size=5)
# #print(p3a)
# 
# p3b<- ggplot(allparms, aes(x=state, y=DeltaCrit2,fill=Category)) +
#   geom_hline(yintercept=1,size=1.5,alpha=0.6)+
#   stat_summary(fun.data = quantiles_95, geom="boxplot")+
#   scale_fill_viridis_d(begin=1,end=0.5,option="magma")+xlab("")+
#   ylab("")+
#   theme_bw()+theme(legend.position="bottom") +
#   labs(fill="Category based on IQR")+
#   scale_y_continuous(breaks = seq(-50,100,10))+
#   coord_cartesian(ylim=c(-50,100))+
#   geom_text(aes(x="AK",y=100,label="B: Testing Rate Doubled"),hjust="left",vjust="top",size=5)
# #print(p3b)
# 
# p3c<- ggplot(allparms, aes(x=state, y=DeltaCrit3,fill=Category)) +
#   geom_hline(yintercept=1,size=1.5,alpha=0.6)+
#   stat_summary(fun.data = quantiles_95, geom="boxplot")+
#   scale_fill_viridis_d(begin=1,end=0.5,option="magma")+xlab("")+
#   ylab("")+
#   theme_bw()+theme(legend.position="bottom") +
#   labs(fill="Category based on IQR")+
#   scale_y_continuous(breaks = seq(-50,100,10))+
#   coord_cartesian(ylim=c(-50,100))+
#   geom_text(aes(x="AK",y=100,label="C: Testing Rate Tripled"),hjust="left",vjust="top",size=5)
# #print(p3c)
# 
# fig3<-annotate_figure(ggarrange(p3a,p3b,p3c,nrow=3,
#   common.legend = TRUE, legend = "bottom"),
#                       left=text_grob(bquote(paste(Delta[crit],
#                      " = % Relaxation (>0) or Restriction (<0) to keep R(t)<1")) ,rot=90))
# print(fig3)
# ggsave("Fig3_05_15.pdf",plot=fig3,height=4,width=6,scale=1.75)
# ggsave("Fig3_05_15.jpeg",plot=fig3,height=4,width=6,scale=1.75)
```

<!-- Another way to pose question is, given a desired level of restriction relaxation $\Delta$, what is the minimum increase in testing required.  Re-arranging in terms of $\Omega$ gives: -->

<!-- $$ -->
<!-- \Omega \geq \Omega_{min} = \frac{\beta [\theta_{min}^\eta + \Delta(1-\theta_{min}^\eta)] - \gamma} -->
<!-- {\lambda} -->
<!-- $$ -->

Because each of the parameters $\beta$, $\theta_{min}$, $\eta$, $\gamma$, and $\lambda$ are uncertain, we calculate the posterior distribution of $\Delta_{crit}$ for different values of $\Omega$.  The results across states in Figure 3 for $\Omega = 1, 2, 3$, are shown below.

Note, this ignores the herd immunity term, but that is both time-and path-dependent, so it is not as easy to include.  But almost all states are at s(t)>0.94 at 97.5% confidence, so it's probably negligible at the moment.

```{r testing effectiveness, echo=FALSE,fig.height=6,fig.width=6, fig.cap="Figure S-5. Amount of re-opening/restriction to keep R(t)<1 "}

# alldelta.quants<-data.frame()
# omegavec <- seq(0.1,4,0.1)
# for (j in 1:length(omegavec)) {
#   omega<-omegavec[j]
#   lambdascale <- omega*allparms$lambda
#   deltacrit <- 100*(lambdascale+allparms$gamma-
#                         allparms$beta*allparms$thetamin^allparms$eta)/
#   (allparms$beta - allparms$thetamin^allparms$eta)
#   tmp.df <- allparms[,c("state","Category")]
#   tmp.df$deltacrit <- deltacrit
#   tmp.quants<-as.data.table(aggregate(deltacrit~state,data=tmp.df,quantile,
#             prob=c(0.025,0.05,0.25,0.5,0.75,0.95,0.975)))
#   tmp.quants$omega<-omega
#   alldelta.quants<-rbind(alldelta.quants,tmp.quants)
# }
# 
# figS5<-ggplot(alldelta.quants)+
#   geom_ribbon(aes(x=omega,ymin=deltacrit.2.5.,ymax=deltacrit.97.5.,fill="CrI"))+
#   geom_ribbon(aes(x=omega,ymin=deltacrit.25.,ymax=deltacrit.75.,fill="IQR"))+
#   geom_line(aes(x=omega,y=deltacrit.50.,linetype="Median"))+
#   scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
#   xlab(bquote(paste(Omega," = Relative Change in Testing (1 = unchanged)")))+
#   ylab(bquote(paste(Delta[crit]," = % Relaxation (>0) or restriction (<0) to keep R(t)<1")))+
#   geom_vline(xintercept=1,size=1,alpha=0.6)+
#   geom_hline(yintercept=0,size=1,alpha=0.6)+
#   theme_bw()+theme(legend.position = "bottom")+
#   labs(fill="",linetype="Prediction")+
#   guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2))+
#   coord_cartesian(ylim=c(-50,50),xlim=c(0,4))+
#      facet_wrap(~state)
# print(figS5)
# ggsave("FigS5_05_15.pdf",plot=figS5,height=6,width=6,scale=1.75)
# ggsave("FigS5_05_15.jpeg",plot=figS5,height=6,width=6,scale=1.75)

```


## Impact of different scenarios on daily deaths


```{r scenarioplots , echo=FALSE,fig.height=4,fig.width=6}

folder <- "../SEIR.reopen.state.alt2.2020.06.20"
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"))
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"))
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

datadatestart<-"2020-03-01"
preddateend<-"2020-08-31"
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code

fig4list <- list()
p0list <- list()
p25list <- list()
# New facet label names 
DeltaDelta.labs <- c("Current Reopening", "Current +25% Reopening")
names(DeltaDelta.labs) <- c("0", "0.25")
mu_Lambda.labs <- c("Testing Rate 1X", "Testing Rate 2X")
names(mu_Lambda.labs) <- c("1", "2")
mu_C.labs <- c("Contact Tracing 1X", "Contact Tracing 2X")
names(mu_C.labs) <- c("1", "2")
out.labs <- c("Daily reported cases","Daily confirmed deaths")
names(out.labs) <- c("positiveIncrease","deathIncrease")

statesplot <- c("TX","WA")
scen.df <- data.frame(state=sort(rep(statesplot,8)),
                      mu_C = rep(rep(c(1,1,2,2),2),length(statesplot)),
                      mu_Lambda = rep(rep(c(1,2,1,2),2),length(statesplot)),
                      DeltaDelta = rep(c(rep(0,4),rep(0.25,4)),length(statesplot)),
                      stringsAsFactors = FALSE
)
scen.df$scenarioname <- paste("TimeSeries",scen.df$mu_C,scen.df$mu_Lambda,
                              scen.df$DeltaDelta,sep=".")
scen.df$basename <- paste0("SEIR_",scen.df$state,"_",scen.df$scenarioname,".quantiles.csv")
scen.df$scenariodesc <- paste0(scen.df$mu_C,"X Contact Tracing, ",
                               scen.df$mu_Lambda,"X Testing, Current",
                               ifelse(scen.df$DeltaDelta==0,"",paste0("+",100*scen.df$DeltaDelta,"%")),
                               " Reopening")

allscendat <-data.frame()
for (k in 1:nrow(scen.df)) {
  scenrow <- scen.df[k,]
  statenow <- scenrow$state
  popnow <- fips_table[statenow,"pop"]
  csvfile <- file.path(folder,statenow,scenrow$basename)
  scendat <- read.csv(csvfile,as.is=TRUE)
  scendat$state <- statenow
  scendat$Output_Var[scendat$Output_Var=="N_pos"] <- "positiveIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_pos"] <- "deathIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_T"] <- "death"
  scendat$Output_Var[scendat$Output_Var=="CumPos"] <- "positive"
  scendat$Date <- as.Date(scendat$Time+60,origin=as.Date(datezero))
  scendat <- subset(scendat,Date>=datadatestart)
  scendat$mu_C <- scenrow$mu_C
  scendat$mu_Lambda <- scenrow$mu_Lambda
  scendat$DeltaDelta <- scenrow$DeltaDelta
  allscendat<-rbind(allscendat,scendat)
}

for (statenow in statesplot) {
  dat.df <- subset(alldat.df,state==statenow)
  obsdat.df<-subset(dat.df,state==statenow & (
    Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
  )) 
  cumdat.df <- subset(allcumdat.df,state==statenow)
  obsdat.df<-rbind(obsdat.df,
                   subset(cumdat.df,state==statenow & (
    Output_Var == "positive" | Output_Var == "death"
  )))
  ## DeltaDelta=0
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta==0 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  #ymax<-max(tmpdat$Prediction.97.5.,10)
  rampup.df <- subset(tmpdat,Date==preddateend)
  p0<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(p0)
  ## DeltaDelta=0.25
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta==0.25 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  rampup.df <- subset(tmpdat,Date==preddateend)
  p25<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(p25)
  p0list[[statenow]]<-p0
  p25list[[statenow]]<-p25
}

fig4<-ggarrange(plotlist=list(p0list[["TX"]]+ggtitle("TX Current Reopening"),
                              p0list[["WA"]]+ggtitle("WA Current Reopening"),
                              p25list[["TX"]]+ggtitle("TX Current+25% Reopening"),
                              p25list[["WA"]]+ggtitle("WA Current+25% Reopening")),
                ncol=2,nrow=2,
                common.legend = TRUE,
                legend="bottom",
                labels=c("A","B","C","D"))
ggsave("Fig4ABCDlog_06_20.pdf",plot=fig4,height=4,width=6,scale=2.5)
ggsave("Fig4ABCDlog_06_20.jpeg",plot=fig4,height=4,width=6,scale=2.5)
```

```{r scenarioplots with neg, echo=FALSE,fig.height=4,fig.width=6}

folder <- "../SEIR.reopen.state.alt2.2020.06.20"
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"))
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"))
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

datadatestart<-"2020-03-01"
preddateend<-"2020-08-31"
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code

fig4list <- list()
p0list <- list()
p25list <- list()
pneg25list <- list()
# New facet label names 
DeltaDelta.labs <- c("Current Reopening", "Current +25% Reopening")
names(DeltaDelta.labs) <- c("0", "0.25")
mu_Lambda.labs <- c("Testing Rate 1X", "Testing Rate 2X")
names(mu_Lambda.labs) <- c("1", "2")
mu_C.labs <- c("Contact Tracing 1X", "Contact Tracing 2X")
names(mu_C.labs) <- c("1", "2")
out.labs <- c("Daily reported cases","Daily confirmed deaths")
names(out.labs) <- c("positiveIncrease","deathIncrease")

statesplot <- c("TX","WA")
scen.df <- data.frame(state=sort(rep(statesplot,12)),
                      mu_C = rep(rep(c(1,1,2,2),3),length(statesplot)),
                      mu_Lambda = rep(rep(c(1,2,1,2),3),length(statesplot)),
                      DeltaDelta = rep(c(rep(0,4),rep(0.25,4),rep(-0.25,4)),length(statesplot)),
                      stringsAsFactors = FALSE
)
scen.df$scenarioname <- paste("TimeSeries",scen.df$mu_C,scen.df$mu_Lambda,
                              scen.df$DeltaDelta,sep=".")
scen.df$basename <- paste0("SEIR_",scen.df$state,"_",scen.df$scenarioname,".quantiles.csv")
scen.df$scenariodesc <- paste0(scen.df$mu_C,"X Contact Tracing, ",
                               scen.df$mu_Lambda,"X Testing, Current",
                                ifelse(scen.df$DeltaDelta==0.25,
                                       paste0("+",100*scen.df$DeltaDelta,"%"),
                                       ifelse(scen.df$DeltaDelta== -0.25,
                                              paste0(100*scen.df$DeltaDelta,"%"),
                                              "")),
                               " Reopening")

allscendat <-data.frame()
for (k in 1:nrow(scen.df)) {
  scenrow <- scen.df[k,]
  statenow <- scenrow$state
  popnow <- fips_table[statenow,"pop"]
  csvfile <- file.path(folder,statenow,scenrow$basename)
  scendat <- read.csv(csvfile,as.is=TRUE)
  scendat$state <- statenow
  scendat$Output_Var[scendat$Output_Var=="N_pos"] <- "positiveIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_pos"] <- "deathIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_T"] <- "death"
  scendat$Output_Var[scendat$Output_Var=="CumPos"] <- "positive"
  scendat$Date <- as.Date(scendat$Time+60,origin=as.Date(datezero))
  scendat <- subset(scendat,Date>=datadatestart)
  scendat$mu_C <- scenrow$mu_C
  scendat$mu_Lambda <- scenrow$mu_Lambda
  scendat$DeltaDelta <- scenrow$DeltaDelta
  allscendat<-rbind(allscendat,scendat)
}

for (statenow in statesplot) {
  dat.df <- subset(alldat.df,state==statenow)
  obsdat.df<-subset(dat.df,state==statenow & (
    Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
  )) 
  cumdat.df <- subset(allcumdat.df,state==statenow)
  obsdat.df<-rbind(obsdat.df,
                   subset(cumdat.df,state==statenow & (
    Output_Var == "positive" | Output_Var == "death"
  )))
  ## DeltaDelta=0
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta==0 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  #ymax<-max(tmpdat$Prediction.97.5.,10)
  rampup.df <- subset(tmpdat,Date==preddateend)
  p0<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    #scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(p0)
  ## DeltaDelta=0.25
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta==0.25 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  rampup.df <- subset(tmpdat,Date==preddateend)
  p25<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    #scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(p25)
  ## DeltaDelta=-0.25
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta== -0.25 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  rampup.df <- subset(tmpdat,Date==preddateend)
  pneg25<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    #scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(pneg25)
  p0list[[statenow]]<-p0
  p25list[[statenow]]<-p25
  pneg25list[[statenow]]<-pneg25
}

fig4neg<-ggarrange(plotlist=list(p0list[["TX"]]+ggtitle("TX Current Reopening"),
                              p0list[["WA"]]+ggtitle("WA Current Reopening"),
                              p25list[["TX"]]+ggtitle("TX Current+25% Reopening"),
                              p25list[["WA"]]+ggtitle("WA Current+25% Reopening"),
                              pneg25list[["TX"]]+ggtitle("TX Current-25% Reopening"),
                              pneg25list[["WA"]]+ggtitle("WA Current-25% Reopening")),
                ncol=2,nrow=3,
                common.legend = TRUE,
                legend="bottom",
                labels=c("A","B","C","D","E","F"))
ggsave("Fig4ABCDEF_06_20.pdf",plot=fig4neg,height=6,width=6,scale=2.5)
ggsave("Fig4ABCDEF_06_20.jpeg",plot=fig4neg,height=6,width=6,scale=2.5)
```


```{r scenarioplots currentreopening, echo=FALSE,fig.height=4,fig.width=6}

folder <- "../SEIR.reopen.state.alt2.2020.06.20"
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"))
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"))
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

datadatestart<-"2020-03-01"
preddateend<-"2020-08-15"
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code

fig4list <- list()
p0list <- list()
# New facet label names 
DeltaDelta.labs <- c("Current Reopening", "Current +25% Reopening")
names(DeltaDelta.labs) <- c("0", "0.25")
mu_Lambda.labs <- c("Testing Rate 1X", "Testing Rate 2X")
names(mu_Lambda.labs) <- c("1", "2")
mu_C.labs <- c("Contact Tracing 1X", "Contact Tracing 2X")
names(mu_C.labs) <- c("1", "2")
out.labs <- c("Daily reported cases","Daily confirmed deaths")
names(out.labs) <- c("positiveIncrease","deathIncrease")

statesplot <- c("NY","OH","TX","WA")
scen.df <- data.frame(state=sort(rep(statesplot,4)),
                      mu_C = rep(rep(c(1,1,2,2),1),length(statesplot)),
                      mu_Lambda = rep(rep(c(1,2,1,2),1),length(statesplot)),
                      DeltaDelta = rep(rep(0,4),length(statesplot)),
                      stringsAsFactors = FALSE
)
scen.df$scenarioname <- paste("TimeSeries",scen.df$mu_C,scen.df$mu_Lambda,
                              scen.df$DeltaDelta,sep=".")
scen.df$basename <- paste0("SEIR_",scen.df$state,"_",scen.df$scenarioname,".quantiles.csv")
scen.df$scenariodesc <- paste0(scen.df$mu_C,"X Contact Tracing, ",
                               scen.df$mu_Lambda,"X Testing, Current",
                                ifelse(scen.df$DeltaDelta==0.25,
                                       paste0("+",100*scen.df$DeltaDelta,"%"),
                                       ifelse(scen.df$DeltaDelta== -0.25,
                                              paste0(100*scen.df$DeltaDelta,"%"),
                                              "")),
                               " Reopening")

allscendat <-data.frame()
for (k in 1:nrow(scen.df)) {
  scenrow <- scen.df[k,]
  statenow <- scenrow$state
  popnow <- fips_table[statenow,"pop"]
  csvfile <- file.path(folder,statenow,scenrow$basename)
  scendat <- read.csv(csvfile,as.is=TRUE)
  scendat$state <- statenow
  scendat$Output_Var[scendat$Output_Var=="N_pos"] <- "positiveIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_pos"] <- "deathIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_T"] <- "death"
  scendat$Output_Var[scendat$Output_Var=="CumPos"] <- "positive"
  scendat$Date <- as.Date(scendat$Time+60,origin=as.Date(datezero))
  scendat <- subset(scendat,Date>=datadatestart)
  scendat$mu_C <- scenrow$mu_C
  scendat$mu_Lambda <- scenrow$mu_Lambda
  scendat$DeltaDelta <- scenrow$DeltaDelta
  allscendat<-rbind(allscendat,scendat)
}

for (statenow in statesplot) {
  dat.df <- subset(alldat.df,state==statenow)
  obsdat.df<-subset(dat.df,state==statenow & (
    Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
  )) 
  cumdat.df <- subset(allcumdat.df,state==statenow)
  obsdat.df<-rbind(obsdat.df,
                   subset(cumdat.df,state==statenow & (
    Output_Var == "positive" | Output_Var == "death"
  )))
  ## DeltaDelta=0
  tmpdat<-subset(allscendat,state == statenow & 
                   (Output_Var=="positiveIncrease" | Output_Var=="deathIncrease") & 
                   DeltaDelta==0 &
                   Date >= datadatestart & 
                   Date <= preddateend)
  #ymax<-max(tmpdat$Prediction.97.5.,10)
  rampup.df <- subset(tmpdat,Date==preddateend)
  p0<-ggplot(tmpdat)+
    geom_col(aes(x=Date,y=Data),data=subset(obsdat.df,Output_Var=="positiveIncrease"|
                                              Output_Var=="deathIncrease"))+
    geom_ribbon(aes(x=Date,ymin=Prediction.2.5.,ymax=Prediction.97.5.,
                    fill="CrI"),alpha=0.8)+
    geom_ribbon(aes(x=Date,ymin=Prediction.25.,ymax=Prediction.75.,
                    fill="IQR"),alpha=0.8)+
    geom_line(aes(x=Date,y=Prediction.50.,linetype="Median"))+
    ylab("Daily reported cases or deaths")+scale_fill_viridis_d(option="magma",begin = 0.6,end=0.95) +
    scale_x_date(date_minor_breaks = "1 week",date_breaks = "month",date_labels = "%b")+
    geom_rect(data=rampup.df,aes(xmin = as.Date("2020-07-01"), xmax = as.Date("2020-07-15"), 
              ymin=0,ymax=Inf,alpha = "Ramp-up period"))+
    scale_alpha_manual(values=0.2)+
    #scale_y_log10(limits=c(1,NA))+
    facet_grid(Output_Var~mu_C+mu_Lambda,scale="free_y",
                  labeller = labeller(mu_C = mu_C.labs,
                                      mu_Lambda = mu_Lambda.labs,
                                      Output_Var = out.labs))+
    guides(linetype = guide_legend(order = 1),fill = guide_legend(order = 2),alpha=guide_legend(order=3))+
          labs(fill="",linetype="Prediction",alpha="")+theme_bw()+theme(legend.position = "bottom")
  print(p0)
  p0list[[statenow]]<-p0+ggtitle(statenow)
}

fig4current<-ggarrange(plotlist=p0list,
                ncol=2,nrow=2,
                common.legend = TRUE,
                legend="bottom",
                labels=c("A","B","C","D"))
ggsave("Fig4ABCDcurrent_06_20-08-15.pdf",plot=fig4current,height=4,width=6,scale=2.5)
ggsave("Fig4ABCDcurrent_06_20-08-15.jpeg",plot=fig4current,height=4,width=6,scale=2.5)
```


```{r scenario Refft, echo=FALSE,fig.height=4,fig.width=6}


preddate<-c("2020-07-15")
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code

# New facet label names 
DeltaDelta.labs <- c("Current Reopening", "Current +25% Reopening")
names(DeltaDelta.labs) <- c("0", "0.25")
mu_Lambda.labs <- c("Testing Rate 1X", "Testing Rate 2X")
names(mu_Lambda.labs) <- c("1", "2")
mu_C.labs <- c("Contact Tracing 1X", "Contact Tracing 2X")
names(mu_C.labs) <- c("1", "2")
out.labs <- c("Daily reported cases","Daily confirmed deaths")
names(out.labs) <- c("positiveIncrease","deathIncrease")

scen.df <- data.frame(state=sort(rep(statesarr,12)),
                      mu_C = rep(rep(c(1,1,2,2),3),length(statesarr)),
                      mu_Lambda = rep(rep(c(1,2,1,2),3),length(statesarr)),
                      DeltaDelta = rep(c(rep(0.25,4),rep(0,4),rep(-0.25,4)),length(statesarr)),
                      stringsAsFactors = FALSE
)
scen.df$scenarioname <- paste("TimeSeries",scen.df$mu_C,scen.df$mu_Lambda,
                              scen.df$DeltaDelta,sep=".")
scen.df$basename <- paste0("SEIR_",scen.df$state,"_",scen.df$scenarioname,".quantiles.csv")
scen.df$scenariodesc <- paste0(scen.df$mu_C,"X Contact Tracing, ",
                               scen.df$mu_Lambda,"X Testing, Current",
                                ifelse(scen.df$DeltaDelta==0.25,
                                       paste0("+",100*scen.df$DeltaDelta,"%"),
                                       ifelse(scen.df$DeltaDelta== -0.25,
                                              paste0(100*scen.df$DeltaDelta,"%"),
                                              "")),
                               " Reopening")
scen.df$scenfactor <- factor(scen.df$scenariodesc,
                             levels=rev(head(scen.df$scenariodesc,12)))
allscendat <-data.frame()
for (k in 1:nrow(scen.df)) {
  scenrow <- scen.df[k,]
  statenow <- scenrow$state
  popnow <- fips_table[statenow,"pop"]
  csvfile <- file.path(folder,statenow,scenrow$basename)
  scendat <- read.csv(csvfile,as.is=TRUE)
  scendat$state <- statenow
  scendat$Output_Var[scendat$Output_Var=="N_pos"] <- "positiveIncrease"
  scendat$Output_Var[scendat$Output_Var=="D_pos"] <- "deathIncrease"
  scendat$Output_Var[scendat$Output_Var=="CumDeath"] <- "death"
  scendat$Output_Var[scendat$Output_Var=="CumPosTest"] <- "positive"
  scendat$Date <- as.Date(scendat$Time+60,origin=as.Date(datezero))
  scendat <- subset(scendat,Date==preddate)
  scendat$mu_C <- scenrow$mu_C
  scendat$mu_Lambda <- scenrow$mu_Lambda
  scendat$DeltaDelta <- scenrow$DeltaDelta
  scendat$scenariodesc <- scenrow$scenariodesc
  scendat$scenfactor <- scenrow$scenfactor
  allscendat<-rbind(allscendat,scendat)
}

Reffscendat <- subset(allscendat,Output_Var == "Refft" & (DeltaDelta<=0 | (mu_C==1 & mu_Lambda==1)))
Reffscendat$R.le.1 <- as.numeric(Reffscendat$Prediction.75.<1)
p<-ggplot(Reffscendat,aes(state,scenfactor))+geom_tile(aes(fill=(R.le.1==1)))+
  scale_fill_viridis_d(option="magma")+labs(fill=bquote(paste("IQR of ",R[eff](t)<1)))+
  theme(legend.position = "bottom")
print(p)
ggsave("heatmap.pdf",p,height=5,width=15)
Reffscendat.wide<-spread(Reffscendat[,c("state","scenfactor","R.le.1")],scenfactor,R.le.1)
Grade.df <- data.frame(state=Reffscendat.wide$state)
Grade.df$value<-"Very High"
Grade.df$value[Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current+25% Reopening`==1] <- "None"
Grade.df$value[Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current+25% Reopening`==0 &
                 Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current Reopening`==1] <- "Low"
Grade.df$value[Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current+25% Reopening`==0 &
                 Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current Reopening`==0 &
                 (Reffscendat.wide$`1X Contact Tracing, 2X Testing, Current Reopening`==1 | 
                    Reffscendat.wide$`2X Contact Tracing, 1X Testing, Current Reopening`==1)] <- "Moderate"
Grade.df$value[Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current+25% Reopening`==0 &
                 Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current Reopening`==0 &
                 (Reffscendat.wide$`1X Contact Tracing, 2X Testing, Current Reopening`==0 & 
                    Reffscendat.wide$`2X Contact Tracing, 1X Testing, Current Reopening`==0) &
                 (Reffscendat.wide$`2X Contact Tracing, 2X Testing, Current Reopening`==1 |
                    Reffscendat.wide$`1X Contact Tracing, 1X Testing, Current-25% Reopening`==1)] <- "High"
Grade.df$value <- factor(Grade.df$value,levels=
                           c("None","Low","Moderate","High","Very High"))
Reffscendat.mat<-as.matrix(Reffscendat.wide[,-1])
rownames(Reffscendat.mat)<-Reffscendat.wide[,1]
heatmap(t(Reffscendat.mat),cexRow = 0.5,cexCol = 0.5)
Reffscendat$stateorder <- factor(Reffscendat$state,
                                 levels=Grade.df$state[order(Grade.df$value)])
porder<-ggplot(Reffscendat,aes(stateorder,scenfactor))+geom_tile(aes(fill=(R.le.1==1)))+
  scale_fill_viridis_d(option="magma")
ggsave("heatmaporder.pdf",porder,height=5,width=15)




pusa<-plot_usmap(data = Grade.df, values = "value") + 
  scale_fill_viridis_d(name = "Mitigation Need", option="magma",direction=-1,begin=0.35) + 
  theme(legend.position = "right")
print(pusa)
ggsave("Fig5A_MitigationNeed.pdf",plot=pusa,height=4,width=6)
ggsave("Fig5A_MitigationNeed.jpeg",plot=pusa,height=4,width=6)

write.csv(x = Grade.df,file="MitigationGrades.csv",row.names = FALSE)
```

```{r prediction table}
folder <- "../SEIR.reopen.state.alt2.2020.06.20"
alldat.df <- read.csv(file.path(folder,"DAILYTESTDATA.csv"),as.is=TRUE)
alldat.df$Date <- as.Date(alldat.df$numDate,origin=as.Date(datezero))
names(alldat.df)[names(alldat.df)=="variable"] <- "Output_Var"
names(alldat.df)[names(alldat.df)=="value"] <- "Data"

allcumdat.df <- read.csv(file.path(folder,"CUMULTESTDATA.csv"),as.is=TRUE)
allcumdat.df$Date <- as.Date(allcumdat.df$numDate,origin=as.Date(datezero))
names(allcumdat.df)[names(allcumdat.df)=="variable"] <- "Output_Var"
names(allcumdat.df)[names(allcumdat.df)=="value"] <- "Data"

date1<-as.Date("2020-06-20")
date2<-as.Date("2020-08-31")
fips_table <- read.csv(file.path(folder,"FIPS_TABLE.csv"),colClasses=c(
  rep("character",4),rep("numeric",2)
))
rownames(fips_table) <- fips_table$Alpha.code

# cat("State\tVariable\tObserved May 15\tShelter-in-Place\t",
#     "Shelter-in-Place + Testing 2X\t",
#     "Relax 20%\t",
#     "Relax 20% + Testing 2X",
#     "\n",sep="", 
#   file="Daily_scenario_predictions.txt",append=FALSE)
# cat("State\tVariable\tObserved May 15\tShelter-in-Place\t",
#     "Shelter-in-Place + Testing 2X\t",
#     "Relax 20%\t",
#     "Relax 20% + Testing 2X",
#     "\n",sep="", 
#   file="Cumulative_scenario_predictions.txt",append=FALSE)
# cat("State\tVariable\tObserved May 15\tShelter-in-Place\t",
#     "Shelter-in-Place + Testing 2X\t",
#     "Relax 20%\t",
#     "Relax 20% + Testing 2X",
#     "\n",sep="", 
#   file="Daily_permil_scenario_predictions.txt",append=FALSE)
# cat("State\tVariable\tObserved May 15\tShelter-in-Place\t",
#     "Shelter-in-Place + Testing 2X\t",
#     "Relax 20%\t",
#     "Relax 20% + Testing 2X",
#     "\n",sep="", 
#   file="Cumulative_permil_scenario_predictions.txt",append=FALSE)

dailysum<-data.frame()
cumulsum<-data.frame()
sumnames <- c("State","Variable","Observed May 15",
              "Shelter-in-Place June 30 GM","Shelter-in-Place June 30 GSD",
    "Shelter-in-Place + Testing 2X June 30 GM","Shelter-in-Place + Testing 2X June 30 GSD",
    "Relax 20% June 30 GM","Relax 20% June 30 GSD",
    "Relax 20% + Testing 2X June 30","Relax 20% + Testing 2X June 30 GSD")

dailytab<-data.frame()
cumultab<-data.frame()
dailypermiltab<-data.frame()
cumulpermiltab<-data.frame()
tabnames<-c(
  "State","Variable","Observed May 15","Shelter-in-Place June 30",
    "Shelter-in-Place + Testing 2X June 30",
    "Relax 20% June 30",
    "Relax 20% + Testing 2X June 30"
)
for (statenow in as.character(fips_table$Alpha.code[2:52])) {
  popnow <- fips_table[statenow,"pop"]
  csvfiles <- list.files(path=file.path(folder,statenow),
                           pattern="Scenario",
                         full.names=TRUE)
  csvfiles <- csvfiles[grep(".csv",csvfiles)]
  csvsplit<-str_split(csvfiles,pattern="_",simplify = TRUE)
  relaxvec<-as.numeric(csvsplit[,4])
  testvec<-as.numeric(csvsplit[,5])
  
  allscendat <-data.frame()
  for (j in 1:length(csvfiles)) {
    scendat <- read.csv(csvfiles[j],as.is=TRUE)
    scendat$state <- statenow
    scendat$Output_Var[scendat$Output_Var=="N_pos"] <- "Daily reported cases"
    scendat$Output_Var[scendat$Output_Var=="D_pos"] <- "Daily confirmed deaths"
    scendat$Output_Var[scendat$Output_Var=="D_T"] <- "Cumulative confirmed deaths"
    scendat$Output_Var[scendat$Output_Var=="CumPos"] <- "Cumulative reported cases"
    scendat[scendat$Output_Var=="Cumulative confirmed deaths" | scendat$Output_Var=="Cumulative reported cases",
            grepl("Prediction",names(scendat))]<-popnow*
      scendat[scendat$Output_Var=="Cumulative confirmed deaths" | scendat$Output_Var=="Cumulative reported cases",
            grepl("Prediction",names(scendat))]
    scendat$Date <- as.Date(scendat$Time,origin=as.Date(datezero))
    scendat$delta <- 100*relaxvec[j]
    scendat$omega <- testvec[j]
    allscendat<-rbind(allscendat,scendat)
  }
  ## Daily Avg for week May 9-May 15
  dat.df <- subset(alldat.df,state==statenow)
  obsdat.df<-subset(dat.df,state==statenow & (
    Output_Var == "positiveIncrease" | Output_Var == "deathIncrease"
  )) 
  obsdat.df$Output_Var[obsdat.df$Output_Var=="positiveIncrease"] <- "Daily reported cases"
  obsdat.df$Output_Var[obsdat.df$Output_Var=="deathIncrease"] <- "Daily confirmed deaths"
  obsdat.df <- subset(obsdat.df,
                      Date >= (date1-6) &
                        Date <= date1)
  avgobs.df<-aggregate(Data~Output_Var,mean,data=obsdat.df)
  avgpermil.df <- avgobs.df
  avgpermil.df$Output_Var<-paste0(avgpermil.df$Output_Var," per mil")
  avgpermil.df$Data <- avgpermil.df$Data/(popnow/1e6)
  # Cumulative for May 15
  cumdat.df <- subset(allcumdat.df,state==statenow &
                        Date==date1 & (
    Output_Var == "positive" | Output_Var == "death"
  ))
    cumdat.df$Output_Var[cumdat.df$Output_Var=="positive"] <- "Cumulative reported cases"
  cumdat.df$Output_Var[cumdat.df$Output_Var=="death"] <- "Cumulative confirmed deaths"
  cum.df<-aggregate(Data~Output_Var,mean,data=cumdat.df)
  cumpermil.df<-cum.df
  cumpermil.df$Output_Var<-paste0(cumpermil.df$Output_Var," per mil")
  cumpermil.df$Data<-cumpermil.df$Data/(popnow/1e6)
  obs.df <- rbind(avgobs.df,
                     avgpermil.df,
                     cum.df,
                     cumpermil.df)
  ## Predictions
  preddat<-subset(allscendat,(Output_Var=="Daily reported cases" | 
                                Output_Var=="Daily confirmed deaths" | 
                                Output_Var=="Cumulative reported cases" |
                                Output_Var=="Cumulative confirmed deaths"
                                ) &
                    ((delta == 0 & omega == 1) |
                       (delta == 0 & omega == 2) |
                       (delta == 20 & omega == 1) |
                       (delta == 20 & omega == 2)) &
                     Date == date2)
  preddat <- preddat[,names(preddat) %in% c("Date","state","Output_Var",
                                           "Prediction.2.5.",
                                           "Prediction.50.",
                                           "Prediction.97.5.",
                                           "delta","omega")]
  predpermildat <- preddat
  predpermildat[,grepl("Prediction",names(predpermildat))] <- 
    predpermildat[,grepl("Prediction",names(predpermildat))]/(popnow/1e6)
  predpermildat$Output_Var<-paste0(predpermildat$Output_Var," per mil")
  preddat <- rbind(preddat,predpermildat)
  for (j in 1:nrow(obs.df)) {
    obsrow<-obs.df[j,]
    outputvar <- obsrow$Output_Var
    # if (outputvar %in% c("Daily reported cases","Daily confirmed deaths")) {
    #   fname <- "Daily_scenario_predictions.txt"
    # } else if (outputvar %in% c("Cumulative reported cases","Cumulative confirmed deaths")) {
    #   fname <- "Cumulative_scenario_predictions.txt"
    # } else if (outputvar %in% c("Daily confirmed deaths per mil",
    #                             "Daily reported cases per mil")) {
    #   fname <- "Daily_permil_scenario_predictions.txt"
    # } else if (outputvar %in% c("Cumulative reported cases per mil",
    #                             "Cumulative confirmed deaths per mil")) {
    #   fname <- "Cumulative_permil_scenario_predictions.txt"
    # }
    tabrow <- c(as.character(statenow),
                as.character(obsrow$Output_Var),
        format(obsrow$Data,scientific=FALSE,digits=3))
    sumrow <- list(as.character(statenow),
                as.character(obsrow$Output_Var),obsrow$Data)
    # cat(as.character(obsrow$state),
    #     as.character(obsrow$Output_Var),
    #     format(obsrow$Data,scientific=FALSE,digits=3),sep="\t",
    #     file=fname,append=TRUE)
    # cat("\t",
    #     file=fname,append=TRUE)
    for (deltanow in c(0,20)) {
      for (omeganow in c(1,2)) {
        predrow <- subset(preddat,Output_Var==outputvar &
                            delta == deltanow &
                            omega == omeganow)
        tabrow<-c(tabrow,
                  paste0(format(predrow$Prediction.50.,
                      scientific=FALSE,digits=3,nsmall=0)," [",
               format(predrow$Prediction.2.5.,
                      scientific=FALSE,digits=3,nsmall=0),"-",
               format(predrow$Prediction.97.5.,
                      scientific=FALSE,digits=3,nsmall=0),
               "]"))
        sumrow<-c(sumrow,list(
                  predrow$Prediction.50.,
                  (predrow$Prediction.97.5./
                     predrow$Prediction.2.5.)^(1/(2*qnorm(0.975)))))
        # cat(paste0(format(predrow$Prediction.50.,
        #               scientific=FALSE,digits=3,nsmall=0)," [",
        #        format(predrow$Prediction.2.5.,
        #               scientific=FALSE,digits=3,nsmall=0),"-",
        #        format(predrow$Prediction.97.5.,
        #               scientific=FALSE,digits=3,nsmall=0),
        #        "]"),
        # sep="\t",
        # file=fname,append=TRUE)
        # cat("\t",
        # file=fname,append=TRUE)
      }
    }
    # cat("\n",
    #     file=fname,append=TRUE)
    tabrow<-as.data.frame(t(tabrow))
    names(tabrow)<-tabnames
    sumrow<-as.data.frame(sumrow)
    names(sumrow)<-sumnames
    if (outputvar %in% c("Daily reported cases","Daily confirmed deaths")) {
      dailytab<-rbind(dailytab,tabrow)
      dailysum<-rbind(dailysum,sumrow)
    } else if (outputvar %in% c("Cumulative reported cases","Cumulative confirmed deaths")) {
      cumultab<-rbind(cumultab,tabrow)
      cumulsum<-rbind(cumulsum,sumrow)
    } else if (outputvar %in% c("Daily confirmed deaths per mil",
                                "Daily reported cases per mil")) {
      dailypermiltab<-rbind(dailypermiltab,tabrow)
    } else if (outputvar %in% c("Cumulative reported cases per mil",
                                "Cumulative confirmed deaths per mil")) {
      cumulpermiltab<-rbind(cumulpermiltab,tabrow)
    }
  }
}
write.csv(dailytab,"Daily_scenario_predictions.csv",row.names = FALSE)
write.csv(cumultab,"Cumulative_scenario_predictions.csv",row.names = FALSE)
write.csv(dailysum,"Daily_scenario_predictions_sums.csv",row.names = FALSE)
write.csv(cumulsum,"Cumulative_scenario_predictions_sums.csv",row.names = FALSE)
write.csv(dailypermiltab,"Daily_permil_scenario_predictions.csv",row.names = FALSE)
write.csv(cumulpermiltab,"Cumulative_permil_scenario_predictions.csv",row.names = FALSE)
dailypermilsum <- dailysum
gmcols<-grepl("Observed",names(dailypermilsum)) | grepl("GM",names(dailypermilsum))
dailypermilsum[,gmcols]<- dailypermilsum[,gmcols]/fips_table$pop[2:52]
cumulpermilsum<-cumulsum
gmcols<-grepl("Observed",names(cumulpermilsum)) | grepl("GM",names(cumulpermilsum))
cumulpermilsum[,gmcols]<- cumulpermilsum[,gmcols]/fips_table$pop[2:52]
write.csv(dailypermilsum,"Daily_permil_scenario_predictions_sums.csv",row.names = FALSE)
write.csv(cumulpermilsum,"Cumulative_permil_scenario_predictions_sums.csv",row.names = FALSE)
```

